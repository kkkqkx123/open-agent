## 分析总结与建议

基于对 `src\services\llm\enhanced_token_calculation_service.py` 的深入分析，我得出以下结论：

### 核心问题

1. **设计不合理**：作为独立服务存在，但功能与基础服务高度重叠
2. **架构不一致**：没有被注册到依赖注入容器，与系统架构不匹配
3. **高耦合度**：与 LLM 配置系统紧密耦合，违反了松耦合原则
4. **维护成本高**：需要同时维护两套相似的服务

### 推荐方案

**采用装饰器模式进行重构**，理由如下：

1. **保持向后兼容**：现有使用基础服务的代码无需修改
2. **职责分离清晰**：基础服务专注核心功能，装饰器提供增强功能
3. **降低耦合度**：通过配置接口隔离配置系统依赖
4. **易于测试和维护**：各组件职责单一，便于独立测试
5. **符合设计原则**：遵循开闭原则，对扩展开放，对修改关闭

### 实施建议

1. **立即行动**：停止使用 `EnhancedTokenCalculationService`，避免技术债务积累
2. **分阶段重构**：按照路线图逐步实施，降低风险
3. **完善测试**：确保重构过程中功能完整性
4. **文档更新**：及时更新架构文档和使用指南

### 长期收益

1. **降低维护成本**：统一的服务架构，减少重复代码
2. **提高系统稳定性**：清晰的职责边界，减少潜在问题
3. **增强扩展性**：装饰器模式支持灵活的功能扩展
4. **改善开发体验**：一致的 API 和使用方式

这个重构不仅解决了当前的技术问题，还为未来的功能扩展奠定了良好的架构基础。