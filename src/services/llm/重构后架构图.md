# 重构后架构图

## 整体架构概览

```mermaid
graph TB
    subgraph "应用层 (Application Layer)"
        API[REST API]
        TUI[TUI Interface]
        CLI[CLI Interface]
    end
    
    subgraph "服务层 (Services Layer)"
        LM[LLMManager<br/>主协调器]
        CM[ClientManager<br/>客户端管理]
        RE[RequestExecutor<br/>请求执行]
        FM[FallbackManager<br/>降级协调器]
        TGM[TaskGroupManager<br/>任务组管理]
        PM[PluginManager<br/>插件管理]
        TCD[TokenCalcDecorator<br/>Token装饰器]
    end
    
    subgraph "核心层 (Core Layer)"
        CF[LLMFactory<br/>客户端工厂]
        FC[FallbackConfig<br/>降级配置]
        WC[Wrapper Classes<br/>包装器类]
    end
    
    subgraph "基础设施层 (Infrastructure Layer)"
        subgraph "HTTP客户端"
            HCF[HttpClientFactory]
            BHC[BaseHttpClient]
            OHC[OpenAIHttpClient]
            GHC[GeminiHttpClient]
            AHC[AnthropicHttpClient]
        end
        
        subgraph "Token计算"
            TCF[TokenCalculatorFactory]
            BTC[BaseTokenCalculator]
            OTC[OpenAITokenCalculator]
            GTC[GeminiTokenCalculator]
            ATC[AnthropicTokenCalculator]
        end
        
        subgraph "消息转换"
            MC[MessageConverter]
            RC[RequestConverter]
            RC2[ResponseConverter]
            MF[MessageFactory]
        end
        
        subgraph "配置管理"
            CL[ConfigLoader]
            CD[ConfigDiscovery]
            CV[ConfigValidator]
        end
        
        subgraph "重试机制 (新增)"
            RC2[RetryConfig]
            RE2[RetryExecutor]
            RS[RetryStrategies]
        end
        
        subgraph "降级机制 (新增)"
            FC2[FallbackConfig]
            FE[FallbackEngine]
            FT[FallbackTracker]
        end
        
        subgraph "监控统计 (新增)"
            SC[StatsCollector]
            PM[PerformanceMonitor]
            HC[HealthChecker]
        end
    end
    
    subgraph "接口层 (Interface Layer)"
        ILLM[ILLMClient]
        ILM[ILLMManager]
        IFM[IFallbackManager]
        ITC[ITokenCalculator]
        IHC[IHttpClient]
    end
    
    %% 连接关系
    API --> LM
    TUI --> LM
    CLI --> LM
    
    LM --> CM
    LM --> RE
    LM --> FM
    LM --> TGM
    
    RE --> CF
    FM --> FC
    TCD --> TCF
    
    CF --> HCF
    CF --> TCF
    CF --> MC
    
    HCF --> BHC
    HCF --> OHC
    HCF --> GHC
    HCF --> AHC
    
    TCF --> BTC
    TCF --> OTC
    TCF --> GTC
    TCF --> ATC
    
    BHC --> RC2
    OHC --> RC2
    GHC --> RC2
    AHC --> RC2
    
    BTC --> SC
    OTC --> SC
    GTC --> SC
    ATC --> SC
    
    FC2 --> FE
    FE --> FT
    
    %% 接口依赖
    CF -.-> ILLM
    LM -.-> ILM
    FM -.-> IFM
    TCF -.-> ITC
    BHC -.-> IHC
```

## 重构前后对比

### 重构前架构问题

```mermaid
graph LR
    subgraph "重构前问题"
        A[服务层冗余]
        B[基础设施层功能重复]
        C[职责不清晰]
        D[维护成本高]
    end
    
    subgraph "具体表现"
        A1[工厂模式重复实现]
        A2[连接池重复实现]
        A3[Token计算重复]
        B1[HTTP客户端重复]
        B2[重试机制分散]
        B3[降级系统重复]
        C1[服务层做基础设施工作]
        C2[基础设施层做业务逻辑]
        D1[代码重复率高]
        D2[测试复杂度高]
    end
    
    A --> A1
    A --> A2
    A --> A3
    B --> B1
    B --> B2
    B --> B3
    C --> C1
    C --> C2
    D --> D1
    D --> D2
```

## 数据流架构

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant LM as LLMManager
    participant RE as RequestExecutor
    participant CF as LLMFactory
    participant HCF as HttpClientFactory
    participant TCF as TokenCalculatorFactory
    participant FM as FallbackManager
    participant FE as FallbackEngine
    
    Client->>LM: 发起请求
    LM->>RE: 执行请求
    RE->>CF: 获取客户端
    CF->>HCF: 创建HTTP客户端
    HCF-->>CF: 返回HTTP客户端
    CF-->>RE: 返回LLM客户端
    
    RE->>TCF: 计算Token
    TCF-->>RE: 返回Token数量
    
    RE->>LLM Client: 发送API请求
    alt 请求成功
        LLM Client-->>RE: 返回响应
        RE-->>LM: 返回结果
        LM-->>Client: 返回响应
    else 请求失败
        RE->>FM: 触发降级
        FM->>FE: 执行降级逻辑
        FE-->>FM: 返回降级结果
        FM-->>RE: 返回降级响应
        RE-->>LM: 返回降级结果
        LM-->>Client: 返回降级响应
    end
```

## 组件依赖关系

### 服务层依赖图

```mermaid
graph TD
    subgraph "服务层内部依赖"
        LM[LLMManager] --> CM[ClientManager]
        LM --> RE[RequestExecutor]
        LM --> FM[FallbackManager]
        LM --> TGM[TaskGroupManager]
        
        RE --> CF[Core LLMFactory]
        FM --> FC[Core FallbackConfig]
        TCD --> TCF[Infra TokenCalculatorFactory]
        
        CM --> MS[MetadataService]
        TGM --> CC[ConcurrencyController]
        PM --> PI[PluginInterfaces]
    end
    
    subgraph "外部依赖"
        LM --> Config[ConfigManager]
        LM --> Logger[Logger]
        RE --> CoreFactory[Core Factory]
        FM --> CoreFallback[Core Fallback]
    end
```

### 基础设施层依赖图

```mermaid
graph TD
    subgraph "基础设施层内部依赖"
        HCF[HttpClientFactory] --> BHC[BaseHttpClient]
        HCF --> OHC[OpenAIHttpClient]
        HCF --> GHC[GeminiHttpClient]
        HCF --> AHC[AnthropicHttpClient]
        
        TCF[TokenCalculatorFactory] --> BTC[BaseTokenCalculator]
        TCF --> OTC[OpenAITokenCalculator]
        TCF --> GTC[GeminiTokenCalculator]
        TCF --> ATC[AnthropicTokenCalculator]
        
        MC[MessageConverter] --> RC[RequestConverter]
        MC --> RC2[ResponseConverter]
        MC --> MF[MessageFactory]
        
        CL[ConfigLoader] --> CD[ConfigDiscovery]
        CL --> CV[ConfigValidator]
        
        RC3[RetryExecutor] --> RC4[RetryConfig]
        RC3 --> RS[RetryStrategies]
        
        FE[FallbackEngine] --> FC2[FallbackConfig]
        FE --> FT[FallbackTracker]
        
        SC[StatsCollector] --> PM[PerformanceMonitor]
        PM --> HC[HealthChecker]
    end
    
    subgraph "横切关注点"
        SC --> HCF
        SC --> TCF
        SC --> MC
        RC3 --> HCF
        FE --> HCF
        FE --> TCF
    end
```

## 重构实施路线图

### 阶段1: 删除冗余模块 (第1-2天)

```mermaid
gantt
    title 重构实施时间线
    dateFormat  YYYY-MM-DD
    section 阶段1: 删除冗余
    删除工厂模式重复    :a1, 2024-01-01, 1d
    删除连接池重复      :a2, after a1, 1d
    删除Token计算重复   :a3, after a2, 1d
    删除降级系统重复    :a4, after a3, 1d
    
    section 阶段2: 基础设施完善
    完善重试机制       :b1, after a4, 2d
    完善降级系统       :b2, after b1, 2d
    创建监控统计       :b3, after b2, 2d
    
    section 阶段3: 集成测试
    单元测试          :c1, after b3, 2d
    集成测试          :c2, after c1, 2d
    性能测试          :c3, after c2, 1d
    
    section 阶段4: 文档和部署
    更新文档          :d1, after c3, 1d
    部署验证          :d2, after d1, 1d
```

### 阶段2: 基础设施层完善 (第3-7天)

```mermaid
graph LR
    subgraph "重试机制完善"
        A1[创建RetryConfig]
        A2[创建RetryExecutor]
        A3[集成到HTTP客户端]
    end
    
    subgraph "降级系统完善"
        B1[迁移FallbackConfig]
        B2[创建FallbackEngine]
        B3[集成到请求执行器]
    end
    
    subgraph "监控统计创建"
        C1[创建StatsCollector]
        C2[创建PerformanceMonitor]
        C3[集成到所有组件]
    end
    
    A1 --> A2 --> A3
    B1 --> B2 --> B3
    C1 --> C2 --> C3
```

### 阶段3: 服务层简化 (第8-10天)

```mermaid
graph TD
    subgraph "简化前"
        S1[复杂的FallbackManager]
        S2[重复的TokenCalculationService]
        S3[冗余的工厂类]
        S4[重复的连接池]
    end
    
    subgraph "简化后"
        T1[简化的FallbackManager<br/>纯协调器]
        T2[TokenCalculationDecorator<br/>轻量级装饰器]
        T3[直接使用Core Factory]
        T4[使用基础设施HTTP客户端]
    end
    
    S1 --> T1
    S2 --> T2
    S3 --> T3
    S4 --> T4
```

## 性能优化预期

### 重构前后性能对比

```mermaid
graph LR
    subgraph "重构前"
        P1[代码量: 100%]
        P2[内存使用: 100%]
        P3[启动时间: 100%]
        P4[响应时间: 100%]
    end
    
    subgraph "重构后"
        Q1[代码量: 60%]
        Q2[内存使用: 75%]
        Q3[启动时间: 80%]
        Q4[响应时间: 90%]
    end
    
    P1 -.->|减少40%| Q1
    P2 -.->|减少25%| Q2
    P3 -.->|减少20%| Q3
    P4 -.->|减少10%| Q4
```

### 维护成本对比

```mermaid
graph TD
    subgraph "重构前维护成本"
        M1[代码重复率高]
        M2[测试复杂度高]
        M3[新功能开发慢]
        M4[Bug修复困难]
    end
    
    subgraph "重构后维护成本"
        N1[代码复用率高]
        N2[测试覆盖度高]
        N3[新功能开发快]
        N4[Bug修复容易]
    end
    
    M1 --> N1
    M2 --> N2
    M3 --> N3
    M4 --> N4
```

## 总结

重构后的架构具有以下核心优势：

1. **清晰的职责分离**: 每一层都有明确的职责边界
2. **高度的代码复用**: 基础设施层提供统一的技术组件
3. **简化的依赖关系**: 服务层只依赖基础设施层的稳定接口
4. **优秀的可扩展性**: 新功能可以基于基础设施层快速开发
5. **降低的维护成本**: 减少重复代码，提高开发效率

这次重构将为系统的长期发展奠定坚实的架构基础。