# 工作流配置验证器

这个验证脚本用于检查工作流配置文件是否存在各种问题，包括无效配置、死循环、内存泄漏风险等。

## 使用方法

```bash
python scripts/validate_workflow_config.py <工作流配置文件路径>
```

## 验证功能

### 错误检测（会导致配置无效）
- **节点不存在**：边指向不存在的节点
- **必填字段缺失**：缺少必要的工作流配置字段
- **类型错误**：配置字段类型不正确

### 警告检测（配置有效但存在风险）
- **死循环检测**：检测到节点之间的循环依赖
- **自调用检测**：节点调用自身可能导致无限递归
- **内存泄漏风险**：
  - 大类型字段（如 `List[dict]`, `Dict[str, Any]`）
  - 与 LangGraph 内置字段冲突的字段名（如 `messages`）
- **不可达节点**：没有入口路径的孤立节点
- **条件边问题**：条件边缺少默认路径
- **未知节点类型**：使用了未定义的节点类型

## 反面教材

项目中提供了两个反面教材配置文件：

### 1. bad_example_workflow.yaml
基础问题示例：
- 指向不存在的节点
- 状态字段冲突
- 条件边缺少默认路径

### 2. really_bad_workflow.yaml
严重问题示例：
- 死循环（节点自调用）
- 多个自调用
- 不可达节点
- 大字段类型
- 调用不存在的函数

## 示例输出

### 验证失败的配置
```
正在验证工作流配置: configs/workflows/really_bad_workflow.yaml
============================================================
❌ 配置无效

错误 (1):
  1. 边 3 的目标节点不存在: totally_nonexistent_node

警告 (14):
  1. 检测到循环: infinite_loop_node -> infinite_loop_node
  2. 节点 'infinite_loop_node' 存在自调用，可能导致内存泄漏
  3. 状态字段 'messages' 可能与LangGraph内置字段冲突
  ...
```

### 验证成功的配置
```
正在验证工作流配置: configs/workflows/examples/simple_data_processing.yaml
============================================================
✅ 配置有效

警告 (3):
  1. 状态字段 'metadata' 可能与LangGraph内置字段冲突
  2. 状态字段 'processed_data' 使用大类型 'Dict[str, Any]'，可能导致内存问题
  3. 状态字段 'metadata' 使用大类型 'Dict[str, Any]'，可能导致内存问题
```

## 在开发中的使用建议

1. **开发阶段**：在创建工作流配置后立即运行验证
2. **测试阶段**：将验证脚本集成到测试流程中
3. **部署前**：确保所有工作流配置都通过验证
4. **代码审查**：将验证结果作为代码审查的一部分

## 扩展验证器

可以通过修改 `scripts/validate_workflow_config.py` 来添加更多验证规则：

1. 在 `WorkflowConfigValidator` 类中添加新的验证方法
2. 在 `validate` 方法中调用新的验证方法
3. 根据需要添加新的错误类型或警告类型

## 注意事项

- 警告不会导致配置无效，但应该认真考虑
- 某些警告可能是误报，需要根据具体情况判断
- 验证器基于静态分析，运行时还可能存在其他问题