# 工作流动态注册重构实施指南

## 概述

本文档说明如何将硬编码的工作流和工具注册机制重构为基于配置文件的动态注册系统，实现零代码扩展新工作流和工具类型。

## 执行步骤

### 第一阶段：创建配置文件结构

#### 1. 创建工作流注册表配置
**文件路径**: `configs/workflows/__registry__.yaml`

**设计描述**:
- 定义工作流类型注册信息（名称、类路径、启用状态）
- 列出需要加载的工作流配置文件
- 支持模块化管理，只包含引用信息

#### 2. 创建工具注册表配置
**文件路径**: `configs/tools/__registry__.yaml`

**设计描述**:
- 定义工具类型注册信息
- 列出工具配置文件引用
- 与工作流注册表结构保持一致

#### 3. 创建状态机工作流注册表
**文件路径**: `configs/workflows/state_machine/__registry__.yaml`

**设计描述**:
- 专门管理状态机工作流配置文件
- 简化配置，只包含文件引用列表

### 第二阶段：实现配置解析和验证机制

#### 4. 创建配置验证器基类
**文件路径**: `src/infrastructure/registry/config_validator.py`

**设计描述**:
- 定义验证结果数据结构和严重程度枚举
- 实现基础验证逻辑（必需字段、类型、值验证）
- 提供自定义验证扩展点

#### 5. 创建注册表配置验证器
**文件路径**: `src/infrastructure/registry/registry_validator.py`

**设计描述**:
- 继承基础验证器，专门验证注册表配置
- 验证类路径格式、必需字段、配置文件引用
- 提供详细的错误信息

#### 6. 创建工作流配置验证器
**文件路径**: `src/infrastructure/registry/workflow_validator.py`

**设计描述**:
- 验证工作流配置的结构和一致性
- 检查节点和边的引用关系
- 验证状态机配置的完整性

#### 7. 创建配置解析器
**文件路径**: `src/infrastructure/registry/config_parser.py`

**设计描述**:
- 集成各种验证器，提供统一的配置解析接口
- 在解析时自动执行验证
- 提供详细的错误日志和警告信息

### 第三阶段：实现动态注册管理

#### 8. 创建模块注册管理器
**文件路径**: `src/infrastructure/registry/module_registry_manager.py`

**设计描述**:
- 管理各模块的注册表配置加载
- 提供类型和配置文件的获取接口
- 集成配置解析和验证功能
- 支持配置缓存以提高性能

#### 9. 创建动态导入工具
**文件路径**: `src/infrastructure/registry/dynamic_importer.py`

**设计描述**:
- 实现安全的类动态导入功能
- 处理导入错误并提供友好的错误信息
- 支持导入缓存和重试机制

### 第四阶段：重构工厂类

#### 10. 重构工作流工厂
**文件路径**: `src/application/workflow/factory.py` (修改)

**设计描述**:
- 集成模块注册管理器，支持动态类型注册
- 实现配置驱动的工作流类型推断
- 保持向后兼容性，支持硬编码回退
- 优化工作流创建逻辑

#### 11. 重构工具工厂
**文件路径**: `src/domain/tools/factory.py` (修改)

**设计描述**:
- 移除硬编码的工具类型注册
- 通过注册管理器动态注册工具类型
- 保持现有API不变
- 改进错误处理和日志记录

#### 12. 重构状态机工作流工厂
**文件路径**: `src/application/workflow/state_machine/state_machine_workflow_factory.py` (修改)

**设计描述**:
- 移除硬编码的配置文件映射
- 通过注册管理器动态加载配置映射
- 支持配置热重载
- 简化配置管理逻辑

### 第五阶段：集成到依赖注入系统

#### 13. 更新依赖注入配置
**文件路径**: `src/infrastructure/di_config.py` (修改)

**设计描述**:
- 注册新的配置解析和验证服务
- 注册模块注册管理器
- 配置工厂类使用新的注册机制
- 保持向后兼容的配置选项

#### 14. 更新启动流程
**文件路径**: `src/bootstrap.py` (修改)

**设计描述**:
- 在系统启动时初始化注册管理器
- 执行自动注册流程
- 添加注册状态日志
- 处理注册失败的降级策略

### 第六阶段：实现自动发现功能

#### 15. 创建配置发现器
**文件路径**: `src/infrastructure/registry/config_discoverer.py`

**设计描述**:
- 扫描指定目录自动发现配置文件
- 根据文件模式推断配置类型
- 支持排除规则和过滤条件
- 生成注册表更新建议

#### 16. 实现注册表自动更新
**文件路径**: `src/infrastructure/registry/registry_updater.py`

**设计描述**:
- 基于发现结果自动更新注册表配置
- 支持手动和自动更新模式
- 提供更新预览和确认机制
- 维护注册表配置的格式和结构

### 第七阶段：添加配置热重载

#### 17. 实现配置热重载监听器
**文件路径**: `src/infrastructure/registry/hot_reload_listener.py`

**设计描述**:
- 监听配置文件变化事件
- 智能过滤无关变化事件
- 触发配置重新解析和注册更新
- 提供重载状态通知

#### 18. 集成热重载到工厂类
**修改文件**: 各个工厂类

**设计描述**:
- 注册配置变化监听器
- 实现配置更新时的类型重新注册
- 处理热重载过程中的并发问题
- 提供重载状态查询接口

### 第八阶段：测试和验证

#### 19. 创建单元测试
**文件路径**: `tests/unit/infrastructure/registry/`

**设计描述**:
- 测试配置解析和验证功能
- 测试动态注册管理器
- 测试工厂类的动态注册
- 测试错误处理和边界情况

#### 20. 创建集成测试
**文件路径**: `tests/integration/registry/`

**设计描述**:
- 测试完整的注册流程
- 测试配置热重载功能
- 测试向后兼容性
- 测试性能和稳定性

## 实施注意事项

1. **渐进式迁移**: 保持向后兼容，新旧系统并存
2. **错误处理**: 提供详细的错误信息和降级策略
3. **性能优化**: 使用配置缓存和延迟加载
4. **日志记录**: 添加详细的操作日志便于调试
5. **文档更新**: 同步更新API文档和使用指南

## 预期收益

1. **零代码扩展**: 添加新工作流只需配置文件
2. **模块化管理**: 各模块独立管理注册配置
3. **自动化发现**: 减少手动维护注册表的工作
4. **热重载支持**: 开发时实时更新配置
5. **向后兼容**: 现有代码无需修改