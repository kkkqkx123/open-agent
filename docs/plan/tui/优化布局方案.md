# TUI界面优化布局方案

## 当前布局问题分析

### 现有布局结构
```
┌─────────────────────────────────────────────────────────────┐
│                    标题栏 (Header)                          │
├─────────────┬─────────────────────────────┬─────────────────┤
│   侧边栏    │         主内容区            │  LangGraph面板  │
│  (Sidebar)  │          (Main)             │  (LangGraph)    │
│             │                             │                 │
│ - 状态概览  │ - 对话历史                  │ - 当前节点      │
│ - Agent信息 │ - 流式输出                  │ - 执行路径      │
│ - 工作流状态│ - 工具结果                  │ - 状态快照      │
│ - 核心指标  │                             │                 │
├─────────────┴─────────────────────────────┴─────────────────┤
│                    输入栏 (Input)                           │
├─────────────────────────────────────────────────────────────┤
│                    状态栏 (Status)                          │
└─────────────────────────────────────────────────────────────┘
```

### 主要问题
1. **侧边栏占用空间过大**：在大屏幕下占用25字符宽度，信息密度低
2. **LangGraph面板使用率低**：仅在调试时有用，占用固定空间
3. **主内容区受限**：两侧面板挤压主工作区空间
4. **布局不灵活**：无法根据用户需求动态调整

## 优化后布局设计

### 新的布局结构
```
┌─────────────────────────────────────────────────────────────┐
│                    标题栏 (Header)                          │
├─────────────────────────────────────────────────────────────┤
│                    主内容区 (Main)                          │
│                                                             │
│  - 对话历史                                                 │
│  - 流式输出                                                 │
│  - 工具结果                                                 │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                    输入栏 (Input)                           │
├─────────────────────────────────────────────────────────────┤
│                    状态栏 (Status)                          │
│  [Alt+1]分析 [Alt+2]可视化 [Alt+3]系统 [Alt+4]错误         │
│  [Alt+5]状态 [Alt+6]LangGraph [ESC]返回                    │
├─────────────────────────────────────────────────────────────┤
│                    导航栏 (Navigation)                      │
│  💾 会话: 已连接 | 🤖 Agent: 运行中 | 🔄 工作流: 进行中     │
│  进度: ████████░░ 80% | 消息: 15 | Token: 2,345           │
└─────────────────────────────────────────────────────────────┘
```

### 子页面设计

#### 状态概览子页面 (Alt+5)
```
┌─────────────────────────────────────────────────────────────┐
│             模块化代理框架 - 状态概览                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │  会话信息   │  Agent信息  │ 工作流状态  │  核心指标   │  │
│  │             │             │             │             │  │
│  │ • 会话ID    │ • 名称      │ • 名称      │ • 消息数    │  │
│  │ • 工作流    │ • 模型      │ • 状态      │ • Token数   │  │
│  │ • 状态      │ • 状态      │ • 进度      │ • 成本      │  │
│  │ • 创建时间  │ • 工具数    │ • 迭代次数  │ • 运行时长  │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                   实时性能监控                          │  │
│  │                                                         │  │
│  │  CPU使用率: ████████░░ 75%     内存使用: 256MB/512MB   │  │
│  │  响应时间: 125ms          错误率: 0.2%                │  │
│  │  网络IO: 1.2MB/s         磁盘使用: 45%                │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### LangGraph子页面 (Alt+6)
```
┌─────────────────────────────────────────────────────────────┐
│             模块化代理框架 - LangGraph调试                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┬─────────────────────────────────────┐  │
│  │   当前节点      │           执行路径                  │  │
│  │                 │                                     │  │
│  │  ▶️ 思考节点    │  📍 输入处理                       │  │
│  │  运行中 (2.3s)  │  📍 工具调用                       │  │
│  │                 │  📍 思考节点 (当前)                │  │
│  │  输入: {...}    │  📍 输出生成                       │  │
│  │  输出: 等待中   │                                     │  │
│  └─────────────────┴─────────────────────────────────────┘  │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                   状态快照                              │  │
│  │                                                         │  │
│  │  {                                                     │  │
│  │    "messages": [...],                                  │  │
│  │    "current_step": "thinking",                         │  │
│  │    "iteration": 3                                      │  │
│  │  }                                                     │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 技术实现方案

### 1. 修改布局管理器

```python
# src/presentation/tui/layout.py
class LayoutManager(ILayoutManager):
    def _create_full_layout(self, layout: Layout) -> Layout:
        """创建完整布局（适用于大屏幕）"""
        # 分割为上下四部分
        layout.split_column(
            Layout(name="header", size=3),
            Layout(name="main"),        # 主内容区占据最大空间
            Layout(name="input", size=3),
            Layout(name="status", size=1),
            Layout(name="navigation", size=2)  # 新增导航栏
        )
        
        # 不再分割主体部分，主内容区占据全宽
        self.region_parent_direction["header"] = "column"
        self.region_parent_direction["main"] = "column"
        self.region_parent_direction["input"] = "column"
        self.region_parent_direction["status"] = "column"
        self.region_parent_direction["navigation"] = "column"
```

### 2. 创建导航栏组件

```python
# src/presentation/tui/components/navigation_bar.py
class NavigationBarComponent:
    """导航栏组件"""
    
    def __init__(self, config: Optional[TUIConfig] = None):
        self.config = config
        self.session_info = {}
        self.agent_info = {}
        self.workflow_status = {}
        self.core_metrics = {}
    
    def render(self) -> Panel:
        """渲染导航栏"""
        content = self._create_navigation_content()
        
        return Panel(
            content,
            style="dim",
            border_style="dim"
        )
    
    def _create_navigation_content(self) -> Text:
        """创建导航内容"""
        nav_text = Text()
        
        # 会话状态
        if self.session_info.get("session_id"):
            session_status = self._get_session_status_text(self.session_info["status"])
            nav_text.append("💾 会话: ", style="bold blue")
            nav_text.append(f"{session_status} | ", style="dim")
        
        # Agent状态
        agent_status = self._get_status_text(self.agent_info.get("status", "就绪"))
        nav_text.append("🤖 Agent: ", style="bold cyan")
        nav_text.append(f"{agent_status} | ", style="dim")
        
        # 工作流状态
        workflow_state = self._get_workflow_state_text(self.workflow_status.get("state", "停止"))
        nav_text.append("🔄 工作流: ", style="bold yellow")
        nav_text.append(f"{workflow_state} | ", style="dim")
        
        # 进度条（如果正在运行）
        progress = self.workflow_status.get("progress", 0)
        if progress > 0:
            progress_bar = self._create_mini_progress_bar(progress)
            nav_text.append("进度: ", style="bold")
            nav_text.append(f"{progress_bar} | ", style="dim")
        
        # 核心指标
        messages = self.core_metrics.get("messages", 0)
        tokens = self.core_metrics.get("tokens", 0)
        nav_text.append("消息: ", style="bold")
        nav_text.append(f"{messages} | ", style="dim")
        nav_text.append("Token: ", style="bold")
        nav_text.append(f"{tokens:,}", style="dim")
        
        return nav_text
```

### 3. 创建LangGraph子页面

```python
# src/presentation/tui/subviews/langgraph.py
class LangGraphSubview(BaseSubview):
    """LangGraph调试子界面"""
    
    def __init__(self, config: TUIConfig):
        super().__init__(config)
        self.current_node_data = {}
        self.execution_path = []
        self.state_snapshot = {}
    
    def render(self) -> Panel:
        """渲染LangGraph界面"""
        # 使用列布局展示节点信息和执行路径
        content = Columns([
            self._create_current_node_panel(),
            self._create_execution_path_panel()
        ], equal=False)
        
        # 添加状态快照面板
        snapshot_panel = self._create_snapshot_panel()
        
        # 垂直组合
        from rich.layout import Layout
        layout = Layout()
        layout.split_column(
            Layout(content),
            Layout(snapshot_panel)
        )
        
        return Panel(
            layout,
            title=self.create_header(),
            border_style="cyan"
        )
```

### 4. 更新渲染控制器

```python
# src/presentation/tui/render_controller.py
class RenderController:
    def __init__(self, layout_manager, components, subviews, config):
        # 添加新的组件和子界面
        self.navigation_component = components.get("navigation")
        self.langgraph_view = subviews.get("langgraph")
        
    def _update_main_view(self, state_manager):
        """更新主界面"""
        # 更新导航栏
        self._update_navigation_bar()
        # ... 其他更新逻辑
    
    def _update_navigation_bar(self):
        """更新导航栏"""
        if self.navigation_component:
            nav_content = self.navigation_component.render()
            self.layout_manager.update_region_content(LayoutRegion.NAVIGATION, nav_content)
    
    def _render_subview(self, state_manager):
        """渲染子界面"""
        if state_manager.current_subview == "langgraph" and self.langgraph_view:
            content = self.langgraph_view.render()
            # ... 子界面渲染逻辑
```

### 5. 添加快捷键支持

```python
# 在状态管理器中添加新的快捷键
# Alt+5: 切换到状态概览子页面
# Alt+6: 切换到LangGraph子页面
```

## 布局区域配置更新

```python
# 更新布局区域配置
regions = {
    LayoutRegion.HEADER: RegionConfig(
        name="标题栏",
        min_size=3, max_size=5, resizable=False
    ),
    LayoutRegion.MAIN: RegionConfig(
        name="主内容区",
        min_size=20, ratio=3, resizable=True
    ),
    LayoutRegion.INPUT: RegionConfig(
        name="输入栏",
        min_size=3, max_size=5, resizable=False
    ),
    LayoutRegion.STATUS: RegionConfig(
        name="状态栏",
        min_size=1, max_size=1, resizable=False
    ),
    LayoutRegion.NAVIGATION: RegionConfig(  # 新增导航栏
        name="导航栏",
        min_size=2, max_size=3, resizable=False
    )
    # 移除SIDEBAR和LANGGRAPH区域
}
```

## 响应式布局适配

### 小屏幕适配
在小屏幕下，导航栏可以进一步简化，只显示最关键的信息：

```
导航栏: 💾已连接 | 🤖运行中 | 进度:80% | 消息:15
```

### 中等屏幕适配
保持完整导航栏，但可以调整信息密度。

## 预期效果

### 空间利用率提升
- **主内容区增加40%**：移除侧边栏和LangGraph面板
- **信息密度优化**：导航栏提供关键状态概览
- **布局更灵活**：按需访问详细状态信息

### 用户体验改善
- **工作区更专注**：主内容区无干扰
- **状态访问便捷**：快捷键快速切换
- **信息层次清晰**：摘要信息在导航栏，详细信息在子页面

### 性能优化
- **渲染负担减轻**：减少同时显示的组件数量
- **内存使用优化**：按需加载详细界面
- **响应速度提升**：简化主界面渲染

## 实施优先级

### 高优先级
1. 创建导航栏组件
2. 修改布局管理器
3. 更新渲染控制器

### 中优先级
1. 创建状态概览子页面
2. 创建LangGraph子页面
3. 添加快捷键支持

### 低优先级
1. 优化响应式布局
2. 添加动画效果
3. 性能调优

此方案将显著改善TUI界面的空间利用率和用户体验，同时保持功能的完整性。