## 滚轮事件错误解析的完整解决方案

### 问题诊断

滚轮事件被错误解析为重复的`[A[A[A[A[A[A[A[A[A[A[A[A[A[A[A[A[B[B[B[B[B[B[B[B[B`字符序列，这是因为：

1. **终端鼠标事件使用ESC序列编码**
2. **当前事件引擎无法识别鼠标事件**，将其当作普通字符处理
3. **鼠标滚轮事件被误判为键盘方向键输入**

### 解决方案：修改事件引擎以正确识别鼠标事件

```python
# 在 src/presentation/tui/event_engine.py 的 _convert_key_sequence 方法中添加鼠标事件识别

def _convert_key_sequence(self, char: str) -> str:
    """将字符转换为按键字符串，支持鼠标事件"""
    # 处理特殊字符
    if char == '\x1b':  # ESC
        try:
            if not self.input_queue.empty():
                next_char = self.input_queue.get_nowait()
                if next_char == '[':
                    # 方向键序列或鼠标事件
                    if not self.input_queue.empty():
                        direction = self.input_queue.get_nowait()
                        
                        # 方向键处理（原有逻辑）
                        if direction == 'A': return "up"
                        elif direction == 'B': return "down"  
                        elif direction == 'C': return "right"
                        elif direction == 'D': return "left"
                        
                        # 鼠标滚轮事件识别（新增）
                        elif direction == 'M':  # 鼠标按下事件
                            # 读取鼠标事件详细信息
                            if not self.input_queue.empty():
                                btn_char = self.input_queue.get_nowait()
                                # 鼠标滚轮：btn_char 32=上滚, 33=下滚
                                if btn_char == ' ':  # 空格表示滚轮上滚
                                    return "wheel_up"
                                elif btn_char == '!':  # 感叹号表示滚轮下滚
                                    return "wheel_down"
                        
                        # XTerm风格的鼠标滚轮事件
                        elif direction in ['6', '7']:  # 64=上滚, 65=下滚
                            if direction == '6': return "wheel_up"
                            elif direction == '7': return "wheel_down"
                            
        except queue.Empty:
            return "escape"
    
    # 其他原有处理逻辑保持不变...
    return f"char:{char}"
```

### 添加上下文感知的滚轮处理

```python
# 在 src/presentation/tui/app.py 中添加滚轮事件处理

def _register_global_shortcuts(self) -> None:
    """注册全局快捷键，包括滚轮事件"""
    # 原有快捷键注册...
    
    # 添加滚轮事件处理
    self.event_engine.register_key_handler("wheel_up", self._handle_mouse_wheel)
    self.event_engine.register_key_handler("wheel_down", self._handle_mouse_wheel)

def _handle_mouse_wheel(self, key: str) -> bool:
    """处理鼠标滚轮事件
    
    Args:
        key: 按键类型 ("wheel_up" 或 "wheel_down")
        
    Returns:
        bool: 是否处理了该事件
    """
    # 只在主内容区域处理滚轮事件，不在输入框中处理
    if (self.state_manager.current_subview is None and 
        not self.state_manager.show_session_dialog and 
        not self.state_manager.show_agent_dialog):
        
        if key == "wheel_up":
            self.main_content_component.scroll_up()
            return True
        elif key == "wheel_down":
            self.main_content_component.scroll_down() 
            return True
    
    return False
```

### 启用终端鼠标支持

```python
# 在 TUIApp.run() 方法中启用终端鼠标支持
def run(self) -> None:
    """运行TUI应用程序"""
    try:
        self.running = True
        
        # 设置终端模式，启用鼠标支持
        with self.terminal.cbreak(), self.terminal.hidden_cursor():
            # 启用鼠标事件报告
            print("\033[?1003h")  # 启用所有鼠标事件报告
            
            # 主循环...
            
    finally:
        # 退出时禁用鼠标事件报告
        print("\033[?1003l")
```

### 实施步骤

1. **修改事件引擎**：在[`_convert_key_sequence()`](src/presentation/tui/event_engine.py:157)中添加鼠标事件识别
2. **注册滚轮处理器**：在[`_register_global_shortcuts()`](src/presentation/tui/app.py:336)中注册滚轮事件处理
3. **实现滚轮处理**：添加[`_handle_mouse_wheel()`](src/presentation/tui/app.py)方法
4. **启用终端鼠标支持**：在应用启动时启用鼠标事件报告

### 预期效果

- ✅ 滚轮事件不再被错误解析为字符输入
- ✅ 滚轮在内容区域正常触发虚拟滚动
- ✅ 滚轮在输入框中不会产生干扰字符
- ✅ 保持与现有键盘快捷键的兼容性


## 滚轮事件错误解析问题分析与解决方案

### 问题诊断
滚轮事件被错误解析为重复的`[A[A[A[A[A[A[A[A[A[A[A[A[A[A[A[A[B[B[B[B[B[B[B[B[B`字符序列，这是因为：

1. **终端鼠标事件使用ESC序列编码**，但当前事件引擎无法识别
2. **鼠标事件被误判为键盘方向键输入**，导致重复字符产生
3. **缺乏鼠标事件专用处理逻辑**，所有输入都被当作字符处理

### 完整解决方案

**核心修改：**
1. **扩展事件引擎**：在[`_convert_key_sequence()`](src/presentation/tui/event_engine.py:157)中添加鼠标滚轮事件识别
2. **添加上下文感知**：滚轮只在内容区域触发滚动，不在输入框中处理
3. **启用终端鼠标支持**：在应用启动时启用鼠标事件报告功能

**技术实现：**
- 识别XTerm和标准终端鼠标事件格式
- 区分滚轮事件和方向键事件
- 保持向后兼容性，不影响现有键盘操作

**预期效果：**
- ✅ 滚轮事件正确触发虚拟滚动
- ✅ 输入框中不再出现干扰字符
- ✅ 保持现有键盘快捷键正常工作
- ✅ 提供流畅的鼠标滚轮用户体验

解决方案已详细分析并提供具体代码实现，可立即实施修复。