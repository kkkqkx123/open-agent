## 阶段1：基础架构搭建（1-2周）
**目标: 建立新的分层架构基础**

**任务清单:**

**接口层创建**
- 创建 src/interfaces/checkpoint/ 目录
- 实现 service.py - 检查点服务接口
- 实现 repository.py - 检查点仓库接口
- 实现 saver.py - 检查点保存器接口
- 更新 src/interfaces/__init__.py 导出新接口

**核心层创建**
- 创建 src/core/checkpoint/ 目录
- 实现 models.py - 检查点数据模型
- 实现 factory.py - 检查点工厂
- 实现 validators.py - 检查点验证器
- 更新 src/core/__init__.py 导出新模型

**服务层创建**
- 创建 src/services/checkpoint/ 目录
- 实现 service.py - 检查点服务实现
- 实现 manager.py - 检查点管理器
- 实现 cache.py - 检查点缓存
- 更新 src/services/__init__.py 导出新服务

---

## 阶段2：适配器层实现（1-2周）

**目标: 实现与存储模块的集成**

**任务清单:**

**适配器层创建**
- 创建 `src/adapters/storage/checkpoint/` 目录
- 实现 `repository.py` - 检查点仓库实现
- 实现 `adapter.py` - 检查点存储适配器
- 实现 `serializer.py` - 检查点序列化器
- 更新 `src/adapters/storage/__init__.py` 导出新适配器

**存储集成**
- 实现检查点到统一存储的映射
- 实现检查点特定的查询逻辑
- 集成存储模块的缓存功能
- 实现存储事务支持

---

## 阶段3：基础设施层重构（1周）

**目标: 重构基础设施层，移除越权功能**

**任务清单:**

**基础设施层重构**
- 重构 `src/infrastructure/graph/checkpoint/` 目录
- 保留 `storage_factory.py` - 检查点存储工厂
- 保留 `config.py` - 检查点配置
- 移除 `manager.py` - 业务逻辑移至服务层
- 移除 `base.py` - 接口移至接口层
- 重构 `memory.py` 和 `sqlite.py` 为存储适配器

**配置文件创建**
- 创建 `configs/checkpoint/` 目录
- 实现 `storage.yaml` - 存储配置
- 实现 `service.yaml` - 服务配置
- 实现 `cache.yaml` - 缓存配置

---

## 阶段4：依赖注入更新（1周）

**目标: 更新依赖注入容器，支持新架构**

**任务清单:**

**容器更新**
- 更新 `src/services/container/` 注册新服务
- 实现检查点服务生命周期管理
- 实现检查点存储工厂注册
- 更新服务解析逻辑

**配置集成**
- 集成检查点配置到系统配置
- 实现配置验证
- 实现环境变量支持

---

## 阶段5：测试和验证（1-2周）

**目标: 确保新架构功能正确**

**任务清单:**

**单元测试**
- 为接口层编写测试
- 为核心层编写测试
- 为服务层编写测试
- 为适配器层编写测试

**集成测试**
- 编写端到端测试
- 测试存储集成
- 测试性能基准
- 测试错误处理

**兼容性测试**
- 测试现有API兼容性
- 测试数据迁移
- 测试配置迁移

---

## 阶段6：迁移和清理（1周）

**目标: 完成代码迁移，清理旧代码**

**任务清单:**

**代码迁移**
- 更新所有引用旧API的代码
- 实现适配器模式支持旧API
- 逐步废弃旧接口
- 更新文档和示例

**清理工作**
- 删除旧的越权代码
- 清理未使用的导入
- 更新代码注释
- 更新架构文档
