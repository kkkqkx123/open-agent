# Anthropicé›†æˆä¿®æ”¹æ‘˜è¦

## ä¿®æ”¹æ¦‚è¿°

åŸºäºAnthropic APIæ–‡æ¡£åˆ†æï¼Œæˆ‘ä»¬å¯¹Anthropicæ ¼å¼è½¬æ¢å™¨è¿›è¡Œäº†å…¨é¢é‡æ„å’Œå¢å¼ºï¼Œä»¥å®Œå…¨ç¬¦åˆæœ€æ–°çš„APIè§„èŒƒã€‚

## ä¸»è¦ä¿®æ”¹

### 1. æ¶æ„é‡æ„

#### æ–°å¢æ¨¡å—åŒ–å·¥å…·ç±»
- `anthropic_multimodal_utils.py` - å¤šæ¨¡æ€å†…å®¹å¤„ç†
- `anthropic_tools_utils.py` - å·¥å…·ä½¿ç”¨å¤„ç†  
- `anthropic_stream_utils.py` - æµå¼å“åº”å¤„ç†
- `anthropic_validation_utils.py` - éªŒè¯å’Œé”™è¯¯å¤„ç†

#### æ ¸å¿ƒç±»æ›´æ–°
- `AnthropicFormatUtils` - é›†æˆæ‰€æœ‰å·¥å…·ç±»çš„ä¸»è¦è½¬æ¢å™¨
- `MessageConverter` - å¢å¼ºAnthropicæ ¼å¼å¤„ç†
- `ProviderResponseConverter` - æ·»åŠ æµå¼å“åº”æ”¯æŒ

### 2. åŠŸèƒ½å¢å¼º

#### è¯·æ±‚è½¬æ¢æ”¹è¿›
- âœ… æ›´æ–°é»˜è®¤æ¨¡å‹ä¸º `claude-sonnet-4-5`
- âœ… å®Œæ•´çš„ `tool_choice` å‚æ•°æ”¯æŒ
- âœ… å¤šæ¨¡æ€å†…å®¹å¤„ç†ï¼ˆæ–‡æœ¬+å›¾åƒï¼‰
- âœ… å…ƒæ•°æ®å‚æ•°æ”¯æŒ
- âœ… å…¨é¢çš„å‚æ•°éªŒè¯

#### å“åº”è½¬æ¢æ”¹è¿›
- âœ… å®Œæ•´çš„å·¥å…·ä½¿ç”¨å“åº”å¤„ç†
- âœ… æ­£ç¡®çš„åœæ­¢åŸå› å¤„ç†
- âœ… ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯å¤„ç†
- âœ… æµå¼å“åº”æ”¯æŒ

#### å·¥å…·ä½¿ç”¨å¢å¼º
- âœ… å®Œæ•´çš„å·¥å…·å®šä¹‰æ ¼å¼è½¬æ¢
- âœ… æ‰€æœ‰å·¥å…·é€‰æ‹©ç­–ç•¥æ”¯æŒï¼ˆauto/none/any/toolï¼‰
- âœ… å·¥å…·è°ƒç”¨å’Œç»“æœå¤„ç†
- âœ… å·¥å…·éªŒè¯é€»è¾‘

#### å¤šæ¨¡æ€æ”¯æŒ
- âœ… æ”¯æŒJPEGã€PNGã€GIFã€WebPæ ¼å¼
- âœ… å›¾åƒå¤§å°å’Œæ ¼å¼éªŒè¯
- âœ… æ··åˆå†…å®¹å¤„ç†
- âœ… å†…å®¹æ ¼å¼è½¬æ¢

#### æµå¼å“åº”
- âœ… Server-Sent Eventsè§£æ
- âœ… æµå¼äº‹ä»¶å¤„ç†
- âœ… å®æ—¶æ–‡æœ¬å’Œå·¥å…·è°ƒç”¨æå–
- âœ… æµå¼éªŒè¯

### 3. éªŒè¯å’Œé”™è¯¯å¤„ç†

#### è¯·æ±‚éªŒè¯
- âœ… æ¨¡å‹éªŒè¯
- âœ… å‚æ•°èŒƒå›´éªŒè¯
- âœ… å·¥å…·å®šä¹‰éªŒè¯
- âœ… å†…å®¹æ ¼å¼éªŒè¯

#### å“åº”éªŒè¯
- âœ… å“åº”æ ¼å¼éªŒè¯
- âœ… å†…å®¹ç»“æ„éªŒè¯
- âœ… ä½¿ç”¨ç»Ÿè®¡éªŒè¯

#### é”™è¯¯å¤„ç†
- âœ… è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹
- âœ… å‹å¥½é”™è¯¯æ¶ˆæ¯
- âœ… APIé”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 4. æµ‹è¯•è¦†ç›–

#### å•å…ƒæµ‹è¯•
- âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•
- âœ… å·¥å…·ä½¿ç”¨æµ‹è¯•
- âœ… å¤šæ¨¡æ€æµ‹è¯•
- âœ… æµå¼å“åº”æµ‹è¯•
- âœ… éªŒè¯å’Œé”™è¯¯å¤„ç†æµ‹è¯•

#### æµ‹è¯•å·¥å…·
- âœ… pytesté…ç½®
- âœ… æµ‹è¯•fixture
- âœ… æ¨¡æ‹Ÿæ•°æ®
- âœ… æµ‹è¯•è¦†ç›–ç‡

## å…¼å®¹æ€§

### å‘åå…¼å®¹
- âœ… ä¿æŒç°æœ‰APIæ¥å£
- âœ… é»˜è®¤å‚æ•°å…¼å®¹
- âœ… é”™è¯¯å¤„ç†å…¼å®¹

### æ–°åŠŸèƒ½
- âœ… å¯é€‰çš„æ–°å‚æ•°æ”¯æŒ
- âœ… å¢å¼ºçš„åŠŸèƒ½å¯é€‰å¯ç”¨
- âœ… æ¸è¿›å¼å‡çº§è·¯å¾„

## æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ä¼˜åŒ–
- âœ… æµå¼å¤„ç†å‡å°‘å†…å­˜å ç”¨
- âœ… æŒ‰éœ€å†…å®¹å¤„ç†
- âœ… åŠæ—¶èµ„æºé‡Šæ”¾

### å¤„ç†ä¼˜åŒ–
- âœ… æ‰¹é‡éªŒè¯
- âœ… ç¼“å­˜æœºåˆ¶
- âœ… ä¼˜åŒ–ç®—æ³•

## æ–‡æ¡£æ›´æ–°

### æ–°å¢æ–‡æ¡£
- âœ… `anthropic_integration_guide.md` - å®Œæ•´é›†æˆæŒ‡å—
- âœ… `anthropic_changes_summary.md` - ä¿®æ”¹æ‘˜è¦
- âœ… å•å…ƒæµ‹è¯•æ–‡æ¡£

### æ›´æ–°æ–‡æ¡£
- âœ… APIå‚æ•°å‚è€ƒï¼ˆå·²å­˜åœ¨ï¼‰
- âœ… æ¶æ„æ–‡æ¡£å¼•ç”¨

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```python
from src.infrastructure.llm.converters.provider_format_utils import get_provider_format_utils_factory

factory = get_provider_format_utils_factory()
anthropic_utils = factory.get_format_utils("anthropic")

# åŸºæœ¬è¯·æ±‚
request = anthropic_utils.convert_request(messages, parameters)
response = anthropic_utils.convert_response(api_response)
```

### å·¥å…·ä½¿ç”¨
```python
parameters = {
    "model": "claude-sonnet-4-5",
    "max_tokens": 1024,
    "tools": tools,
    "tool_choice": {"type": "tool", "name": "specific_tool"}
}
```

### å¤šæ¨¡æ€å†…å®¹
```python
content = [
    {"type": "text", "text": "Analyze this image"},
    {"type": "image", "source": {...}}
]
```

### æµå¼å“åº”
```python
events = []
for line in stream:
    event = anthropic_utils.stream_utils.parse_stream_event(line)
    if event:
        events.append(event)

message = anthropic_utils.convert_stream_response(events)
```

## éªŒè¯æ–¹æ³•

### è¿è¡Œæµ‹è¯•
```bash
uv run pytest tests/infrastructure/llm/converters/test_anthropic_format_utils.py -v
```

### ä»£ç è´¨é‡æ£€æŸ¥
```bash
uv run mypy src/infrastructure/llm/converters/anthropic_format_utils.py --follow-imports=silent
```

## åç»­è®¡åˆ’

### çŸ­æœŸ
- âœ… å®Œæˆå½“å‰å®ç°
- âœ… æµ‹è¯•éªŒè¯
- âœ… æ–‡æ¡£æ›´æ–°

### ä¸­æœŸ
- ğŸ”„ æ€§èƒ½ä¼˜åŒ–
- ğŸ”„ æ›´å¤šæµ‹è¯•ç”¨ä¾‹
- ğŸ”„ é›†æˆæµ‹è¯•

### é•¿æœŸ
- ğŸ“‹ ç›‘æ§å’ŒæŒ‡æ ‡
- ğŸ“‹ è‡ªåŠ¨åŒ–æµ‹è¯•
- ğŸ“‹ æŒç»­é›†æˆ

## æ€»ç»“

æœ¬æ¬¡ä¿®æ”¹å…¨é¢æå‡äº†Anthropic APIçš„é›†æˆè´¨é‡ï¼Œå®ç°äº†ï¼š

1. **å®Œæ•´çš„APIæ”¯æŒ** - æ”¯æŒæ‰€æœ‰å®˜æ–¹APIåŠŸèƒ½
2. **æ¨¡å—åŒ–æ¶æ„** - æ¸…æ™°çš„èŒè´£åˆ†ç¦»
3. **å…¨é¢çš„éªŒè¯** - ç¡®ä¿æ•°æ®æ­£ç¡®æ€§
4. **å¼ºå¤§çš„é”™è¯¯å¤„ç†** - å‹å¥½çš„é”™è¯¯ä¿¡æ¯
5. **å®Œæ•´çš„æµ‹è¯•è¦†ç›–** - ä¿è¯ä»£ç è´¨é‡
6. **è¯¦ç»†çš„æ–‡æ¡£** - ä¾¿äºä½¿ç”¨å’Œç»´æŠ¤

è¿™äº›æ”¹è¿›ä¸ºç”¨æˆ·æä¾›äº†æ›´å¥½çš„å¼€å‘ä½“éªŒï¼ŒåŒæ—¶ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚