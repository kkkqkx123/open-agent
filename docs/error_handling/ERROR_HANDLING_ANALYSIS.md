# é”™è¯¯å¤„ç†ä½“ç³»åˆ†ææŠ¥å‘Š

## ä¸€ã€ç°çŠ¶åˆ†æ

### 1. é”™è¯¯å¤„ç†æ¶æ„æ¦‚è§ˆ

é¡¹ç›®é‡‡ç”¨**å¤šå±‚æ¬¡ã€åˆ†æ•£å¼**çš„é”™è¯¯å¤„ç†æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Adapters Layer                             â”‚
â”‚  API (middleware) â”‚ CLI â”‚ TUI â”‚ Storage                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Services Layer                             â”‚
â”‚  Logger â”‚ LLM â”‚ Tools â”‚ Session â”‚ Workflow                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Core Layer                                â”‚
â”‚  Config â”‚ State â”‚ Workflow â”‚ Prompts â”‚ Tools                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Interfaces Layer                             â”‚
â”‚         Exception Definitions (centralized)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å¼‚å¸¸å®šä¹‰åˆ†æ•£æƒ…å†µ

**åˆ†æ•£ç¨‹åº¦ï¼šâš ï¸ ä¸­ç­‰**

- âœ… **é›†ä¸­åŒ–ï¼š** æ‰€æœ‰å¼‚å¸¸å®šä¹‰ä½äº `src/core/common/exceptions/` ç›®å½•
- âœ… **ç»Ÿä¸€å¯¼å‡ºï¼š** é€šè¿‡ `__init__.py` ç»Ÿä¸€å¯¼å‡ºæ‰€æœ‰å¼‚å¸¸
- âš ï¸ **åˆ†æ•£å®ç°ï¼š** 12 ä¸ªç‹¬ç«‹çš„å¼‚å¸¸æ¨¡å—
  - `llm.py` (10+å¼‚å¸¸)
  - `storage.py` (11å¼‚å¸¸)
  - `workflow.py` (15å¼‚å¸¸)
  - `state.py` (6å¼‚å¸¸)
  - `config.py`, `prompt.py`, `history.py`, `checkpoint.py`, `repository.py`, `session_thread.py`, `tool.py`, `llm_wrapper.py`

### 3. é”™è¯¯å¤„ç†å™¨åˆ†æ•£æƒ…å†µ

**åˆ†æ•£ç¨‹åº¦ï¼šâš ï¸ è¾ƒä¸¥é‡**

#### é”™è¯¯å¤„ç†å™¨ä½ç½®åˆ†å¸ƒ

```
src/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ error_recovery.py          (ConfigErrorRecovery)
â”‚   â”œâ”€â”€ prompts/
â”‚   â”‚   â””â”€â”€ error_handler.py           (PromptErrorHandler)
â”‚   â””â”€â”€ workflow/
â”‚       â””â”€â”€ error_recovery.py          (ErrorRecoveryPlugin)
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ logger/
â”‚   â”‚   â””â”€â”€ error_handler.py           (GlobalErrorHandler)
â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”œâ”€â”€ error_handler.py           (BaseErrorHandler + æ¨¡å‹ç‰¹å®šå¤„ç†å™¨)
â”‚   â”‚   â””â”€â”€ retry/
â”‚   â”‚       â””â”€â”€ retry_manager.py       (RetryManager)
â”‚   â””â”€â”€ storage/
â”‚       â””â”€â”€ manager.py                 (å¸¦é”™è¯¯å¤„ç†)
â””â”€â”€ adapters/
    â”œâ”€â”€ api/
    â”‚   â”œâ”€â”€ middleware.py              (ErrorHandlingMiddleware)
    â”‚   â”œâ”€â”€ main.py                    (å…¨å±€å¼‚å¸¸å¤„ç†å™¨)
    â”‚   â””â”€â”€ utils/serialization.py     (é”™è¯¯åºåˆ—åŒ–)
    â”œâ”€â”€ cli/
    â”‚   â””â”€â”€ error_handler.py           (CLIErrorHandler)
    â””â”€â”€ storage/
        â””â”€â”€ core/error_handler.py      (StorageErrorHandler)
```

**å…³é”®é—®é¢˜ï¼š**
- ğŸ”´ **8 ä¸ªç‹¬ç«‹çš„é”™è¯¯å¤„ç†å™¨** åˆ†æ•£åœ¨ä¸åŒå±‚çº§
- ğŸ”´ **æ— ç»Ÿä¸€çš„é”™è¯¯å¤„ç†åè°ƒ**ï¼šå„å±‚å„è‡ªä¸ºæ”¿
- ğŸ”´ **ç¼ºä¹å…¨å±€é”™è¯¯å¤„ç†ç­–ç•¥**ï¼šæ²¡æœ‰ç»Ÿä¸€çš„é”™è¯¯è½¬æ¢ã€ä¸ŠæŠ¥ã€é‡è¯•æµç¨‹

---

## äºŒã€è¯¦ç»†é—®é¢˜åˆ†æ

### 2.1 æ¨¡å—é”™è¯¯å¤„ç†è¦†ç›–åº¦

#### ğŸ”´ **ä¸¥é‡ç¼ºé™·æ¨¡å—**

| æ¨¡å— | ä½ç½® | é—®é¢˜ | ä¸¥é‡åº¦ |
|------|------|------|--------|
| **Config** | `src/core/config/base.py` | æ— é”™è¯¯å¤„ç†çš„deep_merge() | ğŸ”´ ä¸¥é‡ |
| | `src/core/config/adapter_factory.py` | å·¥å‚æ–¹æ³•ç¼ºä¹éªŒè¯ | ğŸ”´ ä¸¥é‡ |
| | `src/core/config/callback_manager.py` | å›è°ƒæ‰§è¡Œæ— try-catch | ğŸ”´ ä¸¥é‡ |
| **State** | `src/core/state/implementations/base_state.py` | merge()ã€from_dict()æ— ä¿æŠ¤ | ğŸ”´ ä¸¥é‡ |
| | `src/core/state/factories/state_factory.py` | create_state_from_dict()æ— éªŒè¯ | ğŸ”´ ä¸¥é‡ |
| | `src/core/state/history/history_manager.py` | record_state_change()æ— å¼‚å¸¸å¤„ç† | ğŸ”´ ä¸¥é‡ |
| | `src/core/state/builders/state_builder.py` | build()æ–¹æ³•æ— ä¿æŠ¤ | ğŸ”´ ä¸¥é‡ |
| | `src/core/state/core/state_manager.py` | åˆå§‹åŒ–æ–¹æ³•ç¼ºä¹error handling | ğŸŸ¡ ä¸­ç­‰ |
| **Storage** | `src/adapters/storage/backends/memory_backend.py` | æ–‡ä»¶I/Oé”™è¯¯æœªå¤„ç† | ğŸŸ¡ ä¸­ç­‰ |
| | `src/adapters/storage/backends/file_backend.py` | è·¯å¾„éªŒè¯ç¼ºå¤± | ğŸŸ¡ ä¸­ç­‰ |
| **Tool** | æ— é›†ä¸­é”™è¯¯å¤„ç† | åˆ†æ•£åœ¨å„æ¨¡å—ä¸­ | ğŸŸ¡ ä¸­ç­‰ |

#### âœ… **è¾ƒå¥½çš„é”™è¯¯å¤„ç†æ¨¡å—**

| æ¨¡å— | ä½ç½® | ç‰¹ç‚¹ |
|------|------|------|
| **LLM Service** | `src/services/llm/error_handler.py` | 15+try-except, å·¥å‚æ¨¡å¼ |
| **Session Service** | `src/services/sessions/service.py` | 15+try-except, å®Œæ•´è¦†ç›– |
| **Thread Service** | `src/services/threads/service.py` | 7+try-except, éªŒè¯é”™è¯¯å¤„ç† |
| **Workflow Execution** | `src/services/workflow/execution_service.py` | 6+try-except, æ—¥å¿—é›†æˆ |
| **API Layer** | `src/adapters/api/middleware.py` | å…¨å±€ä¸­é—´ä»¶å¤„ç† |
| **Storage Manager** | `src/services/storage/manager.py` | 12+try-except, ç”Ÿå‘½å‘¨æœŸç®¡ç† |

### 2.2 é”™è¯¯å¤„ç†çš„è¿‡åº¦åˆ†æ•£

#### **é—®é¢˜æè¿°**

åŒä¸€ç±»é”™è¯¯ï¼Œåœ¨ä¸åŒæ¨¡å—æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼š

```python
# âŒ é—®é¢˜1ï¼šçŠ¶æ€é”™è¯¯å¤„ç†ä¸ä¸€è‡´
# åœ¨ state_manager.py ä¸­
except Exception as e:
    logger.error(f"åˆ›å»ºçŠ¶æ€å¤±è´¥: {e}")
    # åæ‰å¼‚å¸¸ï¼Œæ— æ³•è¿½è¸ª

# åœ¨ history_manager.py ä¸­
except Exception as e:
    # ç›´æ¥åæ‰ï¼Œæ— æ—¥å¿—
    pass

# åœ¨ state_factory.py ä¸­
# å®Œå…¨æ— try-catchï¼Œå¼‚å¸¸ç›´æ¥æŠ›å‡º

# âŒ é—®é¢˜2ï¼šé…ç½®é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€
# åœ¨ config/base.py ä¸­
# æ— é”™è¯¯å¤„ç†çš„deep_merge()

# åœ¨ config/adapter_factory.py ä¸­
if not hasattr(module, 'create_adapter'):
    raise ValueError(...)  # åªæ˜¯raiseï¼Œæ— logging

# åœ¨ config_manager.py ä¸­
except ConfigError as e:
    # å®Œæ•´çš„é”™è¯¯æ¢å¤æµç¨‹
    ...

# âŒ é—®é¢˜3ï¼šå·¥å…·é”™è¯¯å¤„ç†åˆ†æ•£
# åœ¨ tools/manager.py
try:
    ...
except Exception as e:
    raise ToolError(...)

# åœ¨å„ä¸ªå·¥å…·å®ç°ä¸­
# ç›´æ¥æŠ›å¼‚å¸¸ï¼Œæ— ç»Ÿä¸€å¤„ç†
```

#### **é—®é¢˜é‡åŒ–**

| ç»´åº¦ | ç»Ÿè®¡ | è¯„ä»· |
|------|------|------|
| å¼‚å¸¸å®šä¹‰æ¨¡å— | 12ä¸ª | åˆ†æ•£ |
| é”™è¯¯å¤„ç†å™¨ | 8ä¸ª | åˆ†æ•£ |
| Try-exceptè¦†ç›– | 70%å·¦å³ | ä¸è¶³ |
| é”™è¯¯å¤„ç†ç­–ç•¥ä¸€è‡´æ€§ | <50% | ä¸¥é‡ä¸ä¸€è‡´ |
| ç¼ºä¹é”™è¯¯å¤„ç†çš„å…³é”®æ¨¡å— | 6ä¸ª | ä¸¥é‡ |

### 2.3 ç¼ºä¹é”™è¯¯å¤„ç†çš„å…³é”®æ¨¡å—

#### **Config æ¨¡å—**

```python
# src/core/config/base.py - ç¬¬156è¡Œ
def _deep_merge(self, ...):
    """NO ERROR HANDLING"""
    # å¯èƒ½å¤±è´¥ï¼š
    # - TypeError: å¦‚æœvalueç±»å‹ä¸åŒ¹é…
    # - KeyError: å¦‚æœkeyä¸å­˜åœ¨
    # - RecursionError: æ·±å±‚åˆå¹¶
    for key, value in updates.items():
        if isinstance(self.data[key], dict):
            self._deep_merge(self.data[key], value)  # æ— ä¿æŠ¤
        else:
            self.data[key] = value
```

**ç¼ºé™·ï¼š**
- âŒ æ— ç±»å‹éªŒè¯
- âŒ æ— é€’å½’æ·±åº¦é™åˆ¶
- âŒ æ— å¼‚å¸¸å¤„ç†
- âŒ æ— æ“ä½œå›æ»š

#### **State æ¨¡å—**

```python
# src/core/state/implementations/base_state.py - ç¬¬128è¡Œ
def merge(self, other_state):
    """NO ERROR HANDLING"""
    # é—®é¢˜ï¼š
    # 1. other_stateå¯èƒ½ä¸ºNone
    # 2. å­—æ®µå¯èƒ½ä¸å…¼å®¹
    # 3. åˆå¹¶å¤±è´¥ä¼šå¯¼è‡´ä¸ä¸€è‡´çŠ¶æ€
    self.metadata.update(other_state.metadata)  # å¯èƒ½å¤±è´¥
    for key, value in other_state.data.items():  # KeyErrorå¯èƒ½
        self.data[key] = value
```

**ç¼ºé™·ï¼š**
- âŒ æ— è¾“å…¥éªŒè¯
- âŒ æ— äº‹åŠ¡è¯­ä¹‰
- âŒ éƒ¨åˆ†æ›´æ–°å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- âŒ æ— é”™è¯¯æ¢å¤

#### **History æ¨¡å—**

```python
# src/core/state/history/history_manager.py - ç¬¬35è¡Œ
def record_state_change(self, agent_id, old_state, new_state, action):
    """NO ERROR HANDLING"""
    # é—®é¢˜ï¼š
    # 1. JSONåºåˆ—åŒ–å¯èƒ½å¤±è´¥
    # 2. æ•°æ®åº“å†™å…¥å¯èƒ½å¤±è´¥
    # 3. æ— é‡è¯•æœºåˆ¶
    record = HistoryRecord(...)
    self.storage.add_record(record)  # æ— try-catch
```

**ç¼ºé™·ï¼š**
- âŒ æ— å¼‚å¸¸å¤„ç†
- âŒ æ— é‡è¯•æœºåˆ¶
- âŒ æ— æ—¥å¿—è®°å½•
- âŒ æ— äº‹åŠ¡ä¿è¯

---

## ä¸‰ã€æ¶æ„æ”¹è¿›æ–¹æ¡ˆ

### 3.1 ç»Ÿä¸€é”™è¯¯å¤„ç†æ¡†æ¶

**ç›®æ ‡ï¼š** å»ºç«‹åˆ†å±‚çš„ã€ç»Ÿä¸€åè°ƒçš„é”™è¯¯å¤„ç†ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Unified Error Handling Framework                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Exception Definition Layer                              â”‚
â”‚     â”œâ”€ Core Exceptions (å·²æœ‰)                              â”‚
â”‚     â””â”€ Error Codes & Mappings (æ–°å¢)                        â”‚
â”‚                                                              â”‚
â”‚  2. Error Handler Registry (æ–°å¢)                           â”‚
â”‚     â”œâ”€ Layer-specific handlers                              â”‚
â”‚     â”œâ”€ Exception-type handlers                              â”‚
â”‚     â””â”€ Custom recovery strategies                           â”‚
â”‚                                                              â”‚
â”‚  3. Error Processing Pipeline (æ–°å¢)                        â”‚
â”‚     â”œâ”€ Error Classification                                 â”‚
â”‚     â”œâ”€ Retry Decision                                       â”‚
â”‚     â”œâ”€ Context Enhancement                                  â”‚
â”‚     â”œâ”€ Logging & Monitoring                                 â”‚
â”‚     â””â”€ User Notification                                    â”‚
â”‚                                                              â”‚
â”‚  4. Recovery Strategies (æ–°å¢)                              â”‚
â”‚     â”œâ”€ Retry with backoff                                   â”‚
â”‚     â”œâ”€ Fallback mechanisms                                  â”‚
â”‚     â”œâ”€ State rollback                                       â”‚
â”‚     â””â”€ Graceful degradation                                 â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å…·ä½“æ”¹è¿›æ­¥éª¤

#### **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç»Ÿä¸€é”™è¯¯å¤„ç†æ¡†æ¶**

```python
# src/core/common/error_management/error_handling_registry.py (æ–°å¢)

from enum import Enum
from typing import Dict, Callable, Type, Optional
from abc import ABC, abstractmethod

class ErrorSeverity(Enum):
    """é”™è¯¯ä¸¥é‡åº¦"""
    CRITICAL = "critical"    # å¿…é¡»ç«‹å³å¤„ç†
    HIGH = "high"           # éœ€è¦ç«‹å³å¤„ç†
    MEDIUM = "medium"       # åº”è¯¥å¤„ç†
    LOW = "low"             # å¯ä»¥å»¶è¿Ÿå¤„ç†
    INFO = "info"           # ä¿¡æ¯æ€§é”™è¯¯

class ErrorCategory(Enum):
    """é”™è¯¯åˆ†ç±»"""
    VALIDATION = "validation"       # éªŒè¯é”™è¯¯
    CONFIGURATION = "configuration" # é…ç½®é”™è¯¯
    RESOURCE = "resource"           # èµ„æºé”™è¯¯
    NETWORK = "network"             # ç½‘ç»œé”™è¯¯
    STORAGE = "storage"             # å­˜å‚¨é”™è¯¯
    STATE = "state"                 # çŠ¶æ€é”™è¯¯
    EXECUTION = "execution"         # æ‰§è¡Œé”™è¯¯
    INTEGRATION = "integration"     # é›†æˆé”™è¯¯

class IErrorHandler(ABC):
    """é”™è¯¯å¤„ç†å™¨æ¥å£"""
    
    @abstractmethod
    def can_handle(self, error: Exception) -> bool:
        """æ˜¯å¦å¯ä»¥å¤„ç†è¯¥é”™è¯¯"""
        pass
    
    @abstractmethod
    def handle(self, error: Exception, context: Dict[str, Any]) -> None:
        """å¤„ç†é”™è¯¯"""
        pass

class ErrorHandlingRegistry:
    """é”™è¯¯å¤„ç†æ³¨å†Œè¡¨ï¼ˆå•ä¾‹ï¼‰"""
    
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance
    
    def __init__(self):
        self.handlers: Dict[Type[Exception], IErrorHandler] = {}
        self.recovery_strategies: Dict[str, Callable] = {}
        self.error_mappings: Dict[str, Dict[str, Any]] = {}
        self._initialize_defaults()
    
    def register_handler(
        self, 
        exception_type: Type[Exception],
        handler: IErrorHandler
    ) -> None:
        """æ³¨å†Œé”™è¯¯å¤„ç†å™¨"""
        self.handlers[exception_type] = handler
    
    def register_recovery_strategy(
        self,
        strategy_name: str,
        strategy_func: Callable
    ) -> None:
        """æ³¨å†Œæ¢å¤ç­–ç•¥"""
        self.recovery_strategies[strategy_name] = strategy_func
    
    def register_error_mapping(
        self,
        error_code: str,
        mapping: Dict[str, Any]
    ) -> None:
        """æ³¨å†Œé”™è¯¯æ˜ å°„"""
        self.error_mappings[error_code] = mapping
    
    def handle_error(
        self,
        error: Exception,
        context: Dict[str, Any]
    ) -> None:
        """å¤„ç†é”™è¯¯"""
        handler = self.handlers.get(type(error))
        if handler:
            handler.handle(error, context)
        else:
            # ä½¿ç”¨é»˜è®¤å¤„ç†å™¨
            self._default_handler(error, context)
    
    def _default_handler(self, error: Exception, context: Dict[str, Any]) -> None:
        """é»˜è®¤é”™è¯¯å¤„ç†"""
        logger.error(
            f"æœªå¤„ç†çš„å¼‚å¸¸: {type(error).__name__}",
            extra={
                "error": str(error),
                "context": context
            }
        )
```

#### **ç¬¬äºŒæ­¥ï¼šæ”¹è¿›å…³é”®æ¨¡å—é”™è¯¯å¤„ç†**

```python
# src/core/config/base.py - æ”¹è¿›

def _deep_merge(self, target: Dict, updates: Dict) -> None:
    """å®‰å…¨çš„æ·±åº¦åˆå¹¶"""
    try:
        if not isinstance(target, dict) or not isinstance(updates, dict):
            raise ConfigValidationError(
                "åˆå¹¶ç›®æ ‡å¿…é¡»æ˜¯å­—å…¸ç±»å‹",
                details={
                    "target_type": type(target).__name__,
                    "updates_type": type(updates).__name__
                }
            )
        
        # åˆå¹¶æ·±åº¦é™åˆ¶
        max_depth = 10
        self._deep_merge_recursive(target, updates, depth=0, max_depth=max_depth)
        
    except ConfigValidationError:
        raise
    except Exception as e:
        raise ConfigError(
            f"é…ç½®åˆå¹¶å¤±è´¥: {e}",
            details={"original_error": str(e)}
        )

def _deep_merge_recursive(
    self, 
    target: Dict, 
    updates: Dict, 
    depth: int,
    max_depth: int
) -> None:
    """é€’å½’åˆå¹¶"""
    if depth > max_depth:
        raise ConfigError("é…ç½®åˆå¹¶æ·±åº¦è¶…è¿‡é™åˆ¶")
    
    for key, value in updates.items():
        try:
            if isinstance(value, dict) and key in target and isinstance(target[key], dict):
                self._deep_merge_recursive(
                    target[key], 
                    value, 
                    depth + 1,
                    max_depth
                )
            else:
                target[key] = value
        except Exception as e:
            logger.warning(f"åˆå¹¶å­—æ®µ {key} å¤±è´¥: {e}")
            raise ConfigError(f"æ— æ³•åˆå¹¶é…ç½®å­—æ®µ {key}", details={"error": str(e)})
```

#### **ç¬¬ä¸‰æ­¥ï¼šä¸ºå…³é”®æ¨¡å—æ·»åŠ é”™è¯¯å¤„ç†**

```python
# src/core/state/history/history_manager.py - æ”¹è¿›

def record_state_change(
    self,
    agent_id: str,
    old_state: Dict[str, Any],
    new_state: Dict[str, Any],
    action: str
) -> str:
    """è®°å½•çŠ¶æ€å˜åŒ–ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
    try:
        # è¾“å…¥éªŒè¯
        if not agent_id:
            raise StateValidationError("agent_idä¸èƒ½ä¸ºç©º")
        
        if not isinstance(old_state, dict) or not isinstance(new_state, dict):
            raise StateValidationError("çŠ¶æ€å¿…é¡»æ˜¯å­—å…¸ç±»å‹")
        
        # åºåˆ—åŒ–æ£€æŸ¥
        try:
            json.dumps(old_state)
            json.dumps(new_state)
        except TypeError as e:
            raise HistoryError(
                f"çŠ¶æ€åŒ…å«ä¸å¯åºåˆ—åŒ–çš„æ•°æ®: {e}",
                details={"field_type": str(type(e))}
            )
        
        # åˆ›å»ºè®°å½•
        record = HistoryRecord(
            agent_id=agent_id,
            old_state=old_state,
            new_state=new_state,
            action=action,
            timestamp=datetime.now()
        )
        
        # å­˜å‚¨è®°å½•ï¼ˆå¸¦é‡è¯•ï¼‰
        return self._store_with_retry(record)
        
    except HistoryError:
        raise
    except Exception as e:
        logger.error(
            f"è®°å½•çŠ¶æ€å˜åŒ–å¤±è´¥: {e}",
            extra={
                "agent_id": agent_id,
                "action": action,
                "error_type": type(e).__name__
            }
        )
        raise HistoryError(f"æ— æ³•è®°å½•çŠ¶æ€å˜åŒ–: {e}") from e

def _store_with_retry(self, record: HistoryRecord, max_retries: int = 3) -> str:
    """å¸¦é‡è¯•çš„å­˜å‚¨"""
    last_error = None
    
    for attempt in range(max_retries):
        try:
            return self.storage.add_record(record)
        except StorageError as e:
            last_error = e
            if attempt < max_retries - 1:
                wait_time = 2 ** attempt  # æŒ‡æ•°é€€é¿
                logger.warning(f"å­˜å‚¨å¤±è´¥ï¼Œ{wait_time}ç§’åé‡è¯•: {e}")
                time.sleep(wait_time)
            else:
                break
    
    raise HistoryError(
        f"å­˜å‚¨çŠ¶æ€å˜åŒ–å¤±è´¥ï¼Œé‡è¯•{max_retries}æ¬¡åæ”¾å¼ƒ",
        details={"last_error": str(last_error)}
    )
```

### 3.3 å»ºç«‹æ ‡å‡†åŒ–é”™è¯¯å¤„ç†æ¨¡å¼

#### **æ¨¡å¼1ï¼šåŸºç¡€æ¨¡å—é”™è¯¯å¤„ç†æ¨¡æ¿**

```python
# æ¨¡æ¿ï¼šæ ‡å‡†çš„é”™è¯¯å¤„ç†æ¨¡å¼

class YourModule:
    def critical_operation(self, *args, **kwargs):
        """å…³é”®æ“ä½œ"""
        try:
            # 1. è¾“å…¥éªŒè¯
            self._validate_inputs(*args, **kwargs)
            
            # 2. æ‰§è¡Œæ“ä½œ
            result = self._execute(*args, **kwargs)
            
            # 3. ç»“æœéªŒè¯
            self._validate_result(result)
            
            return result
            
        except DomainSpecificError:
            # é¢„æœŸçš„ä¸šåŠ¡é”™è¯¯ - ç›´æ¥é‡æ–°æŠ›å‡º
            raise
        
        except Exception as e:
            # æ„å¤–é”™è¯¯ - åŒ…è£…åæŠ›å‡º
            logger.error(f"æ“ä½œå¤±è´¥: {e}", exc_info=True)
            raise YourModuleError(f"æ“ä½œå¤±è´¥: {e}") from e
```

#### **æ¨¡å¼2ï¼šæ“ä½œé‡è¯•æ¨¡å¼**

```python
def operation_with_retry(
    self,
    operation: Callable,
    max_retries: int = 3,
    backoff_factor: float = 2.0,
    retryable_exceptions: Tuple[Type[Exception], ...] = (IOError, TimeoutError)
) -> Any:
    """å¸¦é‡è¯•çš„æ“ä½œæ‰§è¡Œ"""
    last_error = None
    
    for attempt in range(max_retries):
        try:
            return operation()
        except retryable_exceptions as e:
            last_error = e
            if attempt < max_retries - 1:
                wait_time = backoff_factor ** attempt
                logger.warning(f"æ“ä½œå¤±è´¥ï¼Œ{wait_time}ç§’åé‡è¯•: {e}")
                time.sleep(wait_time)
        except Exception as e:
            # ä¸å¯é‡è¯•çš„é”™è¯¯ - ç›´æ¥æŠ›å‡º
            raise
    
    # æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
    raise OperationError(
        f"æ“ä½œåœ¨é‡è¯•{max_retries}æ¬¡åå¤±è´¥",
        details={"last_error": str(last_error)}
    ) from last_error
```

#### **æ¨¡å¼3ï¼šä¼˜é›…é™çº§æ¨¡å¼**

```python
def operation_with_fallback(
    self,
    primary_operation: Callable,
    fallback_operation: Callable,
    context: Dict[str, Any]
) -> Any:
    """å¸¦é™çº§çš„æ“ä½œ"""
    try:
        return primary_operation()
    except (TimeoutError, ServiceUnavailableError) as e:
        logger.warning(f"ä¸»æ“ä½œå¤±è´¥ï¼Œå°è¯•é™çº§: {e}")
        try:
            return fallback_operation()
        except Exception as fallback_error:
            raise OperationError(
                f"ä¸»æ“ä½œå’Œé™çº§éƒ½å¤±è´¥",
                details={
                    "primary_error": str(e),
                    "fallback_error": str(fallback_error)
                }
            ) from fallback_error
```

---

## å››ã€å®æ–½è·¯çº¿å›¾

### ç¬¬1é˜¶æ®µï¼šåŸºç¡€æ¡†æ¶å»ºè®¾ï¼ˆ1-2å‘¨ï¼‰
- [ ] åˆ›å»ºç»Ÿä¸€é”™è¯¯å¤„ç†æ¡†æ¶ (`ErrorHandlingRegistry`)
- [ ] å®šä¹‰æ ‡å‡†é”™è¯¯å¤„ç†æ¨¡å¼
- [ ] å»ºç«‹é”™è¯¯åˆ†ç±»ç³»ç»Ÿ

### ç¬¬2é˜¶æ®µï¼šå…³é”®æ¨¡å—æ”¹é€ ï¼ˆ2-3å‘¨ï¼‰
- [ ] æ”¹è¿› Config æ¨¡å—é”™è¯¯å¤„ç†
- [ ] æ”¹è¿› State æ¨¡å—é”™è¯¯å¤„ç†
- [ ] æ”¹è¿› History æ¨¡å—é”™è¯¯å¤„ç†
- [ ] æ”¹è¿› Storage æ¨¡å—é”™è¯¯å¤„ç†

### ç¬¬3é˜¶æ®µï¼šä¸­ç­‰ä¼˜å…ˆçº§æ¨¡å—ï¼ˆ1-2å‘¨ï¼‰
- [ ] æ”¹è¿› Tool æ¨¡å—é”™è¯¯å¤„ç†
- [ ] æ”¹è¿› Prompt æ¨¡å—é”™è¯¯å¤„ç†
- [ ] ç»Ÿä¸€å·¥ä½œæµé”™è¯¯å¤„ç†

### ç¬¬4é˜¶æ®µï¼šé›†æˆå’Œä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
- [ ] é›†æˆæ‰€æœ‰é”™è¯¯å¤„ç†å™¨åˆ°å…¨å±€æ¡†æ¶
- [ ] å»ºç«‹é”™è¯¯å¤„ç†ç›‘æ§å’Œå‘Šè­¦
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯•

### ç¬¬5é˜¶æ®µï¼šæ–‡æ¡£å’ŒåŸ¹è®­ï¼ˆ1å‘¨ï¼‰
- [ ] ç¼–å†™é”™è¯¯å¤„ç†æŒ‡å—
- [ ] åˆ›å»ºé”™è¯¯å¤„ç†ç¤ºä¾‹
- [ ] å›¢é˜ŸåŸ¹è®­

---

## äº”ã€å»ºè®®çš„ä¼˜å…ˆçº§

### ğŸ”´ **ç´§æ€¥ä¼˜å…ˆï¼ˆP0ï¼‰**
1. **Config æ¨¡å—** - å½±å“æ•´ä¸ªç³»ç»Ÿå¯åŠ¨å’Œé…ç½®
   - `src/core/config/base.py::_deep_merge()` 
   - `src/core/config/adapter_factory.py`

2. **State æ¨¡å—** - å½±å“å·¥ä½œæµçŠ¶æ€ç®¡ç†
   - `src/core/state/implementations/base_state.py`
   - `src/core/state/factories/state_factory.py`

3. **History æ¨¡å—** - å½±å“å†å²è®°å½•å¯é æ€§
   - `src/core/state/history/history_manager.py`

### ğŸŸ¡ **é«˜ä¼˜å…ˆï¼ˆP1ï¼‰**
4. **Storage æ¨¡å—** - å½±å“æ•°æ®æŒä¹…åŒ–
   - `src/adapters/storage/backends/`

5. **Tool æ¨¡å—** - å½±å“å·¥å…·æ‰§è¡Œå¯é æ€§

### ğŸŸ¢ **ä¸­ç­‰ä¼˜å…ˆï¼ˆP2ï¼‰**
6. **ç»Ÿä¸€é”™è¯¯å¤„ç†æ¡†æ¶** - å…¨å±€æ”¹è¿›

---

## å…­ã€å…³é”®æŒ‡æ ‡å’ŒæˆåŠŸæ ‡å‡†

### ä»£ç è´¨é‡æŒ‡æ ‡
- [ ] å¼‚å¸¸å¤„ç†è¦†ç›–åº¦ â‰¥ 95% (å…³é”®æ¨¡å—)
- [ ] é”™è¯¯å¤„ç†æ¨¡å¼ä¸€è‡´æ€§ â‰¥ 90%
- [ ] æ— æœªæ•è·å¼‚å¸¸æ³„æ¼ (ç”Ÿäº§ç¯å¢ƒ)

### å¯ç»´æŠ¤æ€§æŒ‡æ ‡
- [ ] é”™è¯¯å¤„ç†é›†ä¸­åº¦ â‰¥ 80%
- [ ] é”™è¯¯å¤„ç†å™¨é‡ç”¨ç‡ â‰¥ 70%
- [ ] æ–‡æ¡£å®Œæ•´æ€§ = 100%

### å¯é æ€§æŒ‡æ ‡
- [ ] å¹³å‡æ•…éšœæ¢å¤æ—¶é—´ (MTTR) â†“ 50%
- [ ] ä¸å¯æ¢å¤é”™è¯¯ç‡ â†“ 70%
- [ ] ç³»ç»Ÿå¯ç”¨æ€§ â‰¥ 99.5%

---

## é™„å½•Aï¼šå¼‚å¸¸å®šä¹‰æ¨¡å—æ¸…å•

| æ¨¡å— | å¼‚å¸¸æ•°é‡ | å…³é”®å¼‚å¸¸ |
|------|--------|--------|
| `llm.py` | 10+ | LLMCallError, LLMTimeoutError, LLMRateLimitError |
| `storage.py` | 11 | StorageError, StorageConnectionError, StorageTransactionError |
| `workflow.py` | 15 | WorkflowError, WorkflowExecutionError, WorkflowValidationError |
| `state.py` | 6 | StateError, StateValidationError, StateNotFoundError |
| `config.py` | 5+ | ConfigError, ConfigValidationError, ConfigNotFoundError |
| `prompt.py` | 8 | PromptError, PromptValidationError, PromptNotFoundError |
| `history.py` | 6 | HistoryError, TokenCalculationError, CostCalculationError |
| `checkpoint.py` | 3 | CheckpointError, CheckpointNotFoundError, CheckpointStorageError |
| `repository.py` | 5 | RepositoryError, RepositoryNotFoundError, RepositoryOperationError |
| `session_thread.py` | 12 | SessionThreadException, ThreadCreationError, SynchronizationError |
| `tool.py` | 2 | ToolError, ToolExecutionError |
| `llm_wrapper.py` | 4 | WrapperError, WrapperExecutionError |

---

## é™„å½•Bï¼šé”™è¯¯å¤„ç†å™¨æ¸…å•

| å¤„ç†å™¨ | ä½ç½® | åŠŸèƒ½ | è¦†ç›–èŒƒå›´ |
|-------|------|------|--------|
| GlobalErrorHandler | `src/services/logger/error_handler.py` | å…¨å±€é”™è¯¯åˆ†ç±» | åº”ç”¨å±‚ |
| BaseErrorHandler | `src/services/llm/error_handler.py` | LLMé”™è¯¯æ˜ å°„ | LLMæœåŠ¡ |
| StorageErrorHandler | `src/adapters/storage/core/error_handler.py` | å­˜å‚¨é”™è¯¯å¤„ç† | å­˜å‚¨å±‚ |
| PromptErrorHandler | `src/core/prompts/error_handler.py` | æç¤ºè¯é”™è¯¯å¤„ç† | æç¤ºè¯æœåŠ¡ |
| CLIErrorHandler | `src/adapters/cli/error_handler.py` | CLIé”™è¯¯å±•ç¤º | CLIé€‚é…å™¨ |
| ErrorHandlingMiddleware | `src/adapters/api/middleware.py` | APIé”™è¯¯å“åº” | APIé€‚é…å™¨ |
| ConfigErrorRecovery | `src/core/config/error_recovery.py` | é…ç½®æ¢å¤ç­–ç•¥ | é…ç½®ç³»ç»Ÿ |
| ErrorRecoveryPlugin | `src/core/workflow/graph/extensions/plugins/builtin/hooks/error_recovery.py` | å·¥ä½œæµé”™è¯¯æ¢å¤ | å·¥ä½œæµæ‰§è¡Œ |

---

## é™„å½•Cï¼šå»ºè®®æ·»åŠ çš„å¼‚å¸¸ç±»å‹

åŸºäºç°æœ‰ç¼ºé™·åˆ†æï¼Œå»ºè®®æ·»åŠ ä»¥ä¸‹å¼‚å¸¸ç±»å‹ä»¥æ”¹è¿›é”™è¯¯å¤„ç†ï¼š

```python
# src/core/common/exceptions/base.py (æ–°å¢)

class ValidationError(CoreError):
    """éªŒè¯é”™è¯¯åŸºç±»"""
    pass

class RetryableError(CoreError):
    """å¯é‡è¯•é”™è¯¯åŸºç±»"""
    def __init__(self, message: str, retry_after: Optional[float] = None):
        super().__init__(message)
        self.retry_after = retry_after

class RecoveryError(CoreError):
    """æ¢å¤é”™è¯¯åŸºç±»"""
    def __init__(self, message: str, recovery_strategy: Optional[str] = None):
        super().__init__(message)
        self.recovery_strategy = recovery_strategy

class DataIntegrityError(CoreError):
    """æ•°æ®å®Œæ•´æ€§é”™è¯¯"""
    pass

class ResourceExhaustedError(CoreError):
    """èµ„æºè€—å°½é”™è¯¯"""
    pass

class OperationTimeoutError(CoreError):
    """æ“ä½œè¶…æ—¶é”™è¯¯"""
    pass

class CircularDependencyError(CoreError):
    """å¾ªç¯ä¾èµ–é”™è¯¯"""
    pass

class StateInconsistencyError(StateError):
    """çŠ¶æ€ä¸ä¸€è‡´é”™è¯¯"""
    pass
```

---

## æ€»ç»“

é¡¹ç›®çš„é”™è¯¯å¤„ç†ä½“ç³»å­˜åœ¨**ä¸­ç­‰ç¨‹åº¦çš„åˆ†æ•£é—®é¢˜**ï¼š

### ç°çŠ¶
- âœ… **å¼‚å¸¸å®šä¹‰é›†ä¸­åŒ–è¾ƒå¥½** (ä½äº `src/core/common/exceptions/`)
- âš ï¸ **é”™è¯¯å¤„ç†å™¨åˆ†æ•£** (8ä¸ªç‹¬ç«‹å¤„ç†å™¨)
- ğŸ”´ **å…³é”®æ¨¡å—ç¼ºä¹é”™è¯¯å¤„ç†** (6ä¸ªæ¨¡å—)
- ğŸ”´ **é”™è¯¯å¤„ç†ç­–ç•¥ä¸ä¸€è‡´** (å„å±‚è‡ªè¡Œå…¶æ˜¯)

### ä¸»è¦é£é™©
1. **æ•°æ®ä¸ä¸€è‡´** - Configã€Stateã€Historyæ¨¡å—æ— ä¿æŠ¤
2. **éšè—ç¼ºé™·** - å¾ˆå¤šå¼‚å¸¸è¢«åæ‰æ— æ³•è¿½è¸ª
3. **éš¾ä»¥ç»´æŠ¤** - 8ä¸ªåˆ†æ•£çš„å¤„ç†å™¨æ— åè°ƒ
4. **å¯é æ€§ä½** - ç¼ºä¹é‡è¯•å’Œæ¢å¤æœºåˆ¶

### æ”¹è¿›æ–¹å‘
å»ºç«‹**ç»Ÿä¸€çš„åˆ†å±‚é”™è¯¯å¤„ç†æ¡†æ¶**ï¼Œå…³é”®æ­¥éª¤ï¼š
1. å»ºç«‹ `ErrorHandlingRegistry` ä¸­å¤®æ³¨å†Œè¡¨
2. ä¸ºå…³é”®æ¨¡å—è¡¥å……é”™è¯¯å¤„ç†
3. å®šä¹‰æ ‡å‡†åŒ–é”™è¯¯å¤„ç†æ¨¡å¼
4. æ•´åˆæ‰€æœ‰é”™è¯¯å¤„ç†å™¨åˆ°ç»Ÿä¸€æ¡†æ¶

é¢„è®¡æ”¹è¿›å·¥ä½œé‡ï¼š**4-6å‘¨**ï¼Œèƒ½æå‡ç³»ç»Ÿå¯é æ€§ **50%+**
