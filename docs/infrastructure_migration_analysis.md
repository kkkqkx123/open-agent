# åŸºç¡€è®¾æ–½å±‚æ¶æ„ä¼˜åŒ–åˆ†æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æå½“å‰coreå±‚å’Œinterfaceå±‚ä¸­åº”è¯¥è¿ç§»åˆ°infrastructureåŸºç¡€è®¾æ–½å±‚çš„æ–‡ä»¶ï¼Œä»¥ä¼˜åŒ–ç»“æ„å±‚æ¬¡åˆ’åˆ†ï¼Œéµå¾ª"æ¥å£å±‚ â†’ æ ¸å¿ƒå±‚ â†’ æœåŠ¡å±‚ â†’ é€‚é…å™¨å±‚"çš„ä¾èµ–åŸåˆ™ã€‚

## ğŸ¯ è¿ç§»åŸåˆ™

### 1. åŸºç¡€è®¾æ–½å±‚å®šä¹‰
åŸºç¡€è®¾æ–½å±‚åº”è¯¥åŒ…å«ï¼š
- **é€šç”¨å·¥å…·ç±»å’Œå®ç”¨ç¨‹åº**
- **è½¬æ¢å™¨å’Œé€‚é…å™¨**
- **ç¼“å­˜å’Œå­˜å‚¨å®ç°**
- **é…ç½®ç®¡ç†å·¥å…·**
- **åºåˆ—åŒ–/ååºåˆ—åŒ–å·¥å…·**

### 2. è¿ç§»æ ‡å‡†
- **æ— ä¸šåŠ¡é€»è¾‘**ï¼šçº¯æŠ€æœ¯å®ç°ï¼Œä¸åŒ…å«é¢†åŸŸé€»è¾‘
- **å¯å¤ç”¨æ€§**ï¼šå¯ä»¥è¢«å¤šä¸ªæ¨¡å—å¤ç”¨
- **ç¨³å®šæ€§**ï¼šä¸ä¾èµ–ä¸šåŠ¡å˜åŒ–ï¼Œç›¸å¯¹ç¨³å®š
- **æŠ€æœ¯å¯¼å‘**ï¼šä¸»è¦è§£å†³æŠ€æœ¯é—®é¢˜è€Œéä¸šåŠ¡é—®é¢˜

## ğŸ“Š å½“å‰æ¶æ„åˆ†æ

### Coreå±‚éœ€è¦è¿ç§»çš„æ–‡ä»¶

#### 1. LLMå·¥å…·ç±» (`src/core/llm/utils/`)
**è¿ç§»åŸå› **ï¼šè¿™äº›æ˜¯çº¯æŠ€æœ¯å·¥å…·ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

| æ–‡ä»¶ | è¿ç§»ç†ç”± | ç›®æ ‡ä½ç½® |
|------|----------|----------|
| `message_converters.py` | æ¶ˆæ¯æ ¼å¼è½¬æ¢å·¥å…·ï¼Œçº¯æŠ€æœ¯å®ç° | `src/infrastructure/llm/converters/` |
| `token_counter.py` | Tokenè®¡ç®—å·¥å…·ï¼Œé€šç”¨æŠ€æœ¯ç»„ä»¶ | `src/infrastructure/llm/token/` |

#### 2. LLMç¼“å­˜ç³»ç»Ÿ (`src/core/llm/cache/`)
**è¿ç§»åŸå› **ï¼šç¼“å­˜æ˜¯åŸºç¡€è®¾æ–½æœåŠ¡ï¼Œä¸æ˜¯æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

| æ–‡ä»¶ | è¿ç§»ç†ç”± | ç›®æ ‡ä½ç½® |
|------|----------|----------|
| `key_generator.py` | ç¼“å­˜é”®ç”Ÿæˆå·¥å…·ï¼ŒæŠ€æœ¯å®ç° | `src/infrastructure/cache/` |
| `cache_manager.py` | ç¼“å­˜ç®¡ç†å™¨ï¼ŒåŸºç¡€è®¾æ–½æœåŠ¡ | `src/infrastructure/cache/` |
| `gemini_cache_manager.py` | ç‰¹å®šç¼“å­˜å®ç°ï¼ŒæŠ€æœ¯ç»„ä»¶ | `src/infrastructure/cache/providers/` |
| `memory_provider.py` | å†…å­˜ç¼“å­˜æä¾›è€…ï¼ŒåŸºç¡€è®¾æ–½ | `src/infrastructure/cache/providers/` |

#### 3. å·¥å…·æ ¼å¼åŒ–å™¨ (`src/core/tools/formatter.py`)
**è¿ç§»åŸå› **ï¼šæ ¼å¼åŒ–æ˜¯æŠ€æœ¯è½¬æ¢ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

| æ–‡ä»¶ | è¿ç§»ç†ç”± | ç›®æ ‡ä½ç½® |
|------|----------|----------|
| `formatter.py` | å·¥å…·æ ¼å¼åŒ–å·¥å…·ï¼ŒæŠ€æœ¯è½¬æ¢ | `src/infrastructure/tools/formatters/` |

#### 4. é…ç½®ç®¡ç† (`src/core/config/`)
**è¿ç§»åŸå› **ï¼šé…ç½®ç®¡ç†æ˜¯åŸºç¡€è®¾æ–½æœåŠ¡

| æ–‡ä»¶ | è¿ç§»ç†ç”± | ç›®æ ‡ä½ç½® |
|------|----------|----------|
| `adapter_factory.py` | é€‚é…å™¨å·¥å‚ï¼ŒæŠ€æœ¯å®ç° | `src/infrastructure/config/` |
| `adapters.py` | é…ç½®é€‚é…å™¨ï¼ŒæŠ€æœ¯ç»„ä»¶ | `src/infrastructure/config/` |
| `base.py` | é…ç½®åŸºç¡€ç±»ï¼ŒæŠ€æœ¯å®ç° | `src/infrastructure/config/` |

### Interfaceå±‚éœ€è¦è¿ç§»çš„æ–‡ä»¶

#### 1. é€šç”¨æ¥å£ (`src/interfaces/`)
**è¿ç§»åŸå› **ï¼šéƒ¨åˆ†æ¥å£æ›´é€‚åˆä½œä¸ºåŸºç¡€è®¾æ–½æ¥å£

| æ–‡ä»¶ | è¿ç§»ç†ç”± | ç›®æ ‡ä½ç½® |
|------|----------|----------|
| `common_infra.py` | é€šç”¨åŸºç¡€è®¾æ–½æ¥å£ | `src/infrastructure/interfaces/` |
| `configuration.py` | é…ç½®ç›¸å…³æ¥å£ | `src/infrastructure/config/interfaces/` |

## ğŸš€ è¿ç§»è®¡åˆ’

### é˜¶æ®µ1ï¼šLLMç›¸å…³åŸºç¡€è®¾æ–½
- [ ] åˆ›å»º `src/infrastructure/llm/` ç›®å½•ç»“æ„
- [ ] è¿ç§»æ¶ˆæ¯è½¬æ¢å™¨
- [ ] è¿ç§»Tokenè®¡ç®—å·¥å…·
- [ ] æ›´æ–°æ‰€æœ‰å¼•ç”¨

### é˜¶æ®µ2ï¼šç¼“å­˜åŸºç¡€è®¾æ–½ âœ… å·²å®Œæˆ
- [x] åˆ›å»º `src/infrastructure/cache/` ç›®å½•ç»“æ„
- [x] è¿ç§»ç¼“å­˜ç®¡ç†å™¨å’Œç›¸å…³ç»„ä»¶
- [x] è¿ç§»ç¼“å­˜æä¾›è€…ï¼ˆå†…å­˜ã€Geminiï¼‰
- [x] æ›´æ–°æ‰€æœ‰å¼•ç”¨
- [x] åˆ›å»ºå‘åå…¼å®¹å±‚
- [x] éªŒè¯å¯¼å…¥ç»“æ„

### é˜¶æ®µ3ï¼šå·¥å…·åŸºç¡€è®¾æ–½
- [ ] åˆ›å»º `src/infrastructure/tools/` ç›®å½•ç»“æ„
- [ ] è¿ç§»æ ¼å¼åŒ–å™¨
- [ ] æ›´æ–°æ‰€æœ‰å¼•ç”¨

### é˜¶æ®µ4ï¼šé…ç½®åŸºç¡€è®¾æ–½
- [ ] åˆ›å»º `src/infrastructure/config/` ç›®å½•ç»“æ„
- [ ] è¿ç§»é…ç½®ç®¡ç†ç»„ä»¶
- [ ] æ›´æ–°æ‰€æœ‰å¼•ç”¨

## ğŸ“ ç›®æ ‡ç›®å½•ç»“æ„

```
src/infrastructure/
â”œâ”€â”€ interfaces/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ common.py          # ä» interfaces/common_infra.py è¿ç§»
â”‚   â””â”€â”€ config/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ interfaces.py   # ä» interfaces/configuration.py è¿ç§»
â”œâ”€â”€ llm/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ converters/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ message_converters.py  # ä» core/llm/utils/ è¿ç§»
â”‚   â””â”€â”€ token/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ counter.py            # ä» core/llm/utils/ è¿ç§»
â”œâ”€â”€ cache/                        # âœ… å·²å®Œæˆè¿ç§»
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ cache_manager.py     # âœ… ä» core/llm/cache/ è¿ç§»
â”‚   â”‚   â””â”€â”€ key_generator.py     # âœ… ä» core/llm/cache/ è¿ç§»
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ cache_config.py      # âœ… ä» core/llm/cache/ è¿ç§»
â”‚   â””â”€â”€ providers/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ memory/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ memory_provider.py   # âœ… ä» core/llm/cache/ è¿ç§»
â”‚       â””â”€â”€ gemini/
â”‚           â”œâ”€â”€ __init__.py
â”‚           â””â”€â”€ gemini_cache_manager.py  # âœ… ä» core/llm/cache/ è¿ç§»
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ formatters/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ formatter.py         # ä» core/tools/ è¿ç§»
â””â”€â”€ config/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ adapter_factory.py       # ä» core/config/ è¿ç§»
    â”œâ”€â”€ adapters.py              # ä» core/config/ è¿ç§»
    â””â”€â”€ base.py                  # ä» core/config/ è¿ç§»
```

## ğŸ”„ ä¾èµ–å…³ç³»æ›´æ–°

### éœ€è¦æ›´æ–°çš„å¯¼å…¥è¯­å¥

#### Coreå±‚æ–‡ä»¶éœ€è¦æ›´æ–°çš„å¯¼å…¥
```python
# æ—§å¯¼å…¥
from src.core.llm.utils.message_converters import MessageConverter
from src.core.llm.cache.cache_manager import CacheManager
from src.core.tools.formatter import ToolFormatter

# æ–°å¯¼å…¥
from src.infrastructure.llm.converters.message_converters import MessageConverter
from src.infrastructure.cache.cache_manager import CacheManager
from src.infrastructure.tools.formatters.formatter import ToolFormatter
```

#### Serviceå±‚æ–‡ä»¶éœ€è¦æ›´æ–°çš„å¯¼å…¥
```python
# æ—§å¯¼å…¥
from src.core.llm.cache.key_generator import LLMCacheKeyGenerator
from src.core.config.base import BaseConfig

# æ–°å¯¼å…¥
from src.infrastructure.cache.key_generator import LLMCacheKeyGenerator
from src.infrastructure.config.base import BaseConfig
```

## âœ… è¿ç§»éªŒè¯æ¸…å•

### 1. åŠŸèƒ½éªŒè¯
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] åŠŸèƒ½å›å½’æµ‹è¯•é€šè¿‡

### 2. æ€§èƒ½éªŒè¯
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å†…å­˜ä½¿ç”¨æµ‹è¯•
- [ ] å¯åŠ¨æ—¶é—´æµ‹è¯•

### 3. æ¶æ„éªŒè¯
- [ ] ä¾èµ–å…³ç³»æ­£ç¡®
- [ ] å¾ªç¯ä¾èµ–æ£€æŸ¥
- [ ] æ¥å£ä¸€è‡´æ€§æ£€æŸ¥

### 4. æ–‡æ¡£éªŒè¯
- [ ] APIæ–‡æ¡£æ›´æ–°
- [ ] æ¶æ„æ–‡æ¡£æ›´æ–°
- [ ] è¿ç§»æŒ‡å—æ›´æ–°

## ğŸ¯ é¢„æœŸæ”¶ç›Š

### 1. æ¶æ„æ¸…æ™°åº¦
- æ›´æ¸…æ™°çš„å±‚æ¬¡åˆ’åˆ†
- æ›´å¥½çš„èŒè´£åˆ†ç¦»
- æ›´å®¹æ˜“ç†è§£å’Œç»´æŠ¤

### 2. å¯å¤ç”¨æ€§
- åŸºç¡€è®¾æ–½ç»„ä»¶å¯ä»¥åœ¨ä¸åŒé¡¹ç›®ä¸­å¤ç”¨
- å‡å°‘ä»£ç é‡å¤
- æé«˜å¼€å‘æ•ˆç‡

### 3. æµ‹è¯•æ€§
- åŸºç¡€è®¾æ–½ç»„ä»¶å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- æ›´å®¹æ˜“è¿›è¡Œå•å…ƒæµ‹è¯•
- æ›´å¥½çš„æµ‹è¯•è¦†ç›–ç‡

### 4. ç»´æŠ¤æ€§
- åŸºç¡€è®¾æ–½å˜æ›´ä¸å½±å“ä¸šåŠ¡é€»è¾‘
- æ›´å®¹æ˜“è¿›è¡ŒæŠ€æœ¯å‡çº§
- æ›´å¥½çš„ä»£ç ç»„ç»‡

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. è¿ç§»é£é™©
- å¯èƒ½å­˜åœ¨éšè—çš„ä¾èµ–å…³ç³»
- éœ€è¦ä»”ç»†æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- å¯èƒ½éœ€è¦ä¸´æ—¶å…¼å®¹æ€§ä»£ç 

### 2. æ€§èƒ½å½±å“
- å¯¼å…¥è·¯å¾„å˜åŒ–å¯èƒ½å½±å“æ€§èƒ½
- éœ€è¦è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
- å¯èƒ½éœ€è¦ä¼˜åŒ–å¯¼å…¥è¯­å¥

### 3. å›¢é˜Ÿåä½œ
- éœ€è¦å›¢é˜Ÿæˆå‘˜äº†è§£æ–°çš„æ¶æ„
- éœ€è¦æ›´æ–°å¼€å‘æ–‡æ¡£
- å¯èƒ½éœ€è¦è¿›è¡ŒåŸ¹è®­

## ğŸ“… å®æ–½æ—¶é—´è¡¨

### ç¬¬1å‘¨ï¼šå‡†å¤‡é˜¶æ®µ
- è¯¦ç»†åˆ†æä¾èµ–å…³ç³»
- åˆ›å»ºè¿ç§»è®¡åˆ’
- å‡†å¤‡æµ‹è¯•ç”¨ä¾‹

### ç¬¬2å‘¨ï¼šLLMåŸºç¡€è®¾æ–½è¿ç§»
- è¿ç§»æ¶ˆæ¯è½¬æ¢å™¨
- è¿ç§»Tokenè®¡ç®—å·¥å…·
- æ›´æ–°ç›¸å…³å¼•ç”¨

### ç¬¬3å‘¨ï¼šç¼“å­˜åŸºç¡€è®¾æ–½è¿ç§»
- è¿ç§»ç¼“å­˜ç®¡ç†å™¨
- è¿ç§»ç¼“å­˜æä¾›è€…
- æ›´æ–°ç›¸å…³å¼•ç”¨

### ç¬¬4å‘¨ï¼šå·¥å…·å’Œé…ç½®åŸºç¡€è®¾æ–½è¿ç§»
- è¿ç§»å·¥å…·æ ¼å¼åŒ–å™¨
- è¿ç§»é…ç½®ç®¡ç†ç»„ä»¶
- æ›´æ–°ç›¸å…³å¼•ç”¨

### ç¬¬5å‘¨ï¼šéªŒè¯å’Œä¼˜åŒ–
- è¿è¡Œæ‰€æœ‰æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•
- æ–‡æ¡£æ›´æ–°

## ğŸ“ æ€»ç»“

é€šè¿‡è¿™æ¬¡æ¶æ„ä¼˜åŒ–ï¼Œæˆ‘ä»¬å°†ï¼š
1. **æ˜ç¡®å±‚æ¬¡åˆ’åˆ†**ï¼šåŸºç¡€è®¾æ–½å±‚ä¸“æ³¨äºæŠ€æœ¯å®ç°
2. **æé«˜å¯å¤ç”¨æ€§**ï¼šåŸºç¡€è®¾æ–½ç»„ä»¶å¯ä»¥åœ¨å¤šä¸ªé¡¹ç›®ä¸­ä½¿ç”¨
3. **æ”¹å–„ç»´æŠ¤æ€§**ï¼šæŠ€æœ¯å˜æ›´ä¸ä¼šå½±å“ä¸šåŠ¡é€»è¾‘
4. **å¢å¼ºæµ‹è¯•æ€§**ï¼šåŸºç¡€è®¾æ–½ç»„ä»¶å¯ä»¥ç‹¬ç«‹æµ‹è¯•

è¿™ä¸ªè¿ç§»è®¡åˆ’å°†å¸®åŠ©æˆ‘ä»¬å»ºç«‹ä¸€ä¸ªæ›´åŠ æ¸…æ™°ã€å¯ç»´æŠ¤å’Œå¯æ‰©å±•çš„æ¶æ„ã€‚