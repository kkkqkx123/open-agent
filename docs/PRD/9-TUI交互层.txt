# 文档9：TUI交互层需求文档
## 1. 文档标识
- 模块名称：TUI交互层
- 版本：V1.0
- 依赖模块：基础架构与环境配置、Agent核心与工作流、过程记录与会话管理、日志与指标

## 2. 模块目标
实现框架的TUI交互界面，支持Agent选择、会话管理、工作流状态显示、流式输出，提供清晰、友好的用户交互体验，且不包含任何业务逻辑。

## 3. 技术栈
- TUI框架：rich（界面渲染）、click（命令行命令）
- 流式处理：asyncio（异步流式输出）
- 终端控制：blessed（终端大小适配）

## 4. 功能性需求
### 4.1 命令行命令体系
- 基于click实现命令体系，支持以下命令：
  1. `agent run`：启动TUI交互（默认命令）
  2. `agent session list`：列出所有会话
  3. `agent session restore <session_id>`：恢复指定会话并启动TUI
  4. `agent session destroy <session_id>`：销毁指定会话
  5. `agent config check`：检查配置文件完整性
  6. `agent version`：显示框架版本

### 4.2 TUI主界面
- 界面布局（使用rich Layout）：
  ```
  ┌─────────────────────────────────────────┐
  │ 标题栏：Modular Agent Framework v1.0    │
  ├───────────────┬─────────────────────────┤
  │ 侧边栏（25%） │ 主内容区（75%）         │
  │ - Agent信息   │ - 会话历史              │
  │ - 工作流状态  │ - 流式输出              │
  │ - 指标统计    │ - 工具调用结果          │
  ├───────────────┼─────────────────────────┤
  │ 输入栏：用户输入                       │
  └─────────────────────────────────────────┘
  ```

#### 4.2.1 侧边栏
- Agent信息：显示当前使用的Agent名称、LLM模型、工具集
- 工作流状态：
  - 当前节点（如`analyze`/`execute_tool`）
  - 剩余步骤（`3/10`）
  - 异常提示（如工具调用失败，红色显示）
- 指标统计：
  - Token使用（`输入：1200 | 输出：800`）
  - 工具调用（`成功：3 | 失败：1`）
  - 会话时长（`00:05:30`）

#### 4.2.2 主内容区
- 会话历史：按时间顺序显示用户输入（蓝色）、Agent思考过程（灰色，可配置隐藏）、Agent输出（绿色）、工具调用结果（黄色）
- 流式输出：实时显示LLM的流式响应，逐段追加
- 工具调用结果：展开/折叠显示（默认折叠，点击展开），包含工具名称、参数、输出

#### 4.2.3 输入栏
- 支持多行输入（`Shift+Enter`换行）
- 输入历史：`↑`/`↓`键切换历史输入
- 命令支持：输入`/help`显示帮助，`/clear`清空历史，`/exit`退出TUI

### 4.3 交互控制
#### 4.3.1 会话管理
- TUI启动时，提示选择Agent（列出`configs/agents/`下的配置）
- 支持会话切换（`/switch_session <session_id>`）
- 支持新建会话（`/new_session <agent_config_name>`）

#### 4.3.2 工作流控制
- 支持暂停工作流（`/pause`）、继续工作流（`/resume`）、终止工作流（`/stop`）
- 工作流执行过程中，显示实时进度（如`正在调用search_tool...`）

#### 4.3.3 界面配置
- 支持通过配置调整TUI显示：
  ```yaml
  # global.yaml
  tui:
    show_thought: true  # 显示思考过程
    truncate_tool_output: true  # 截断长工具输出（默认200字符）
    tool_output_max_lines: 20  # 工具输出最大显示行数
    color_scheme: "default"  # 颜色方案（default/dark/light）
  ```

### 4.4 错误与反馈
- 错误提示：TUI中用红色显示错误信息（如配置错误、LLM调用失败），点击可查看详情
- 操作反馈：成功操作（如会话创建）用绿色显示提示，3秒后自动隐藏
- 加载状态：工作流执行中显示加载动画（如旋转图标）

## 5. 非功能性需求
- **响应性**：流式输出延迟≤100ms，无卡顿
- **适配性**：支持不同终端大小（最小宽度80字符，高度24行）
- **易用性**：提供`/help`命令，显示所有支持的操作与快捷键

## 6. 依赖接口
- `IAgentCore`（Agent核心模块）：启动Agent运行、控制工作流
- `ISessionManager`（会话管理模块）：创建/恢复/销毁会话
- `ILogger`（日志与指标模块）：显示错误信息、操作反馈
- `IWorkflowMonitor`（Agent核心模块）：获取工作流状态

## 7. 提供接口
- 无（作为用户界面层，仅调用其他模块接口，不提供对外接口）

## 8. 测试要点
- 界面布局测试：不同终端大小的适配
- 交互测试：命令、快捷键、会话切换的正确性
- 流式输出测试：实时显示的流畅性
- 错误反馈测试：错误信息的显示与详情查看
