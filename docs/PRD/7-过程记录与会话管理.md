# 文档7：过程记录与会话管理需求文档（LangGraph集成版）

## 1. 文档标识
- 模块名称：过程记录与会话管理
- 版本：V2.0（LangGraph集成版）
- 依赖模块：基础架构与环境配置、配置系统、Agent核心与工作流
- 重大变更：集成LangGraph状态追踪，简化事件记录

## 2. 模块目标
实现Agent会话的全生命周期管理与过程记录，利用LangGraph内置状态追踪能力，支持会话持久化与回放，确保Agent行为可审计、可复现、可调试。

## 3. 技术栈
- **状态管理**：LangGraph StateGraph（内置状态追踪）
- **存储**：JSON Lines（.jsonl，会话记录）、pickle（状态序列化）
- **版本控制**：gitpython（文件操作检查点）
- **唯一标识**：uuid（session_id生成）

## 4. 功能性需求

### 4.1 会话管理

#### 4.1.1 会话生命周期
- 实现`SessionManager`：
  - 会话创建：`create_session(agent_config_name: str) -> str`，生成唯一`session_id`，初始化LangGraph状态
  - 会话恢复：`restore_session(session_id: str) -> AgentState`，从存储加载历史状态
  - 会话销毁：`destroy_session(session_id: str) -> bool`，删除会话存储文件
  - 会话列表：`list_sessions() -> list[SessionMeta]`，返回会话元信息

#### 4.1.2 会话状态持久化
- 定义`ISessionStore`接口，支持可插拔存储后端
- 存储路径：`sessions/{session_id}/`
- 状态存储：`state.pkl`（序列化LangGraph状态）
- 元信息存储：`meta.json`（会话元信息）

### 4.2 LangGraph状态追踪集成

#### 4.2.1 内置状态追踪
- 利用LangGraph内置的`StateGraph`状态管理能力
- 自动记录节点执行、状态转换、工具调用
- 支持状态快照和回滚功能

#### 4.2.2 事件流记录简化
- 实现`LangGraphEventCollector`：包装LangGraph状态变化为事件
- 支持事件类型：
  - `node_execution`：节点执行记录
  - `state_transition`：状态转换记录
  - `tool_call`：工具调用记录
  - `llm_call`：LLM调用记录

#### 4.2.3 记录存储与脱敏
- 存储后端：`sessions/{session_id}/events.jsonl`
- 脱敏支持：敏感信息自动脱敏
- 记录分割：大文件自动分割

### 4.3 LangGraph Studio集成

#### 4.3.1 可视化回放
- 集成LangGraph Studio提供可视化会话回放
- 支持分步执行、状态查看、节点调试
- 实时显示工作流执行过程

#### 4.3.2 会话恢复执行
- 支持从历史会话恢复后继续执行
- 加载历史LangGraph状态，添加新用户消息
- 新事件追加到事件流

### 4.4 Git版本管理（文件操作检查点）
- 实现`FileCheckpointManager`：
  - 检查点触发：工具修改文件时自动创建Git commit
  - 版本标签：`tool_{tool_name}_{timestamp}`
  - 仓库初始化：会话启动时在`workspace/{session_id}/`初始化Git仓库

## 5. 非功能性需求
- **可靠性**：会话状态保存失败时不影响当前执行
- **性能**：LangGraph状态追踪高效，不阻塞主流程
- **可扩展性**：支持未来扩展到数据库存储

## 6. 依赖接口
- `IConfigSystem`（配置系统模块）：获取会话存储配置
- `IAgentCore`（Agent核心模块）：获取LangGraph状态
- `ILogger`（日志与指标模块）：记录会话操作日志

## 7. 提供接口
- `ISessionManager`：会话管理接口
- `ISessionStore`：存储接口
- `ILangGraphEventCollector`：事件收集接口
- `ISessionPlayer`：回放接口（集成LangGraph Studio）

## 8. 测试要点
- 会话生命周期测试：创建、恢复、销毁的正确性
- LangGraph状态追踪测试：节点执行记录的完整性
- 回放测试：LangGraph Studio可视化回放功能

## 9. 与原始设计的差异

### 简化内容
- **移除**：自定义状态转换事件记录逻辑
- **简化**：事件类型定义（利用LangGraph内置状态）
- **集成**：使用LangGraph Studio替代自定义可视化

### 新增优势
- **标准化**：使用LangGraph标准状态追踪
- **可视化**：集成专业级调试工具
- **维护性**：减少自定义事件记录代码

---
*文档版本：V2.0 - LangGraph集成版*
*更新日期：2025-10-17*