# 文档9：TUI交互层需求文档（LangGraph集成版）

## 1. 文档标识
- 模块名称：TUI交互层
- 版本：V2.0（LangGraph集成版）
- 依赖模块：基础架构与环境配置、Agent核心与工作流、过程记录与会话管理、日志与指标
- 重大变更：集成LangGraph Studio可视化

## 2. 模块目标
实现框架的TUI交互界面，支持Agent选择、会话管理、LangGraph Studio集成、流式输出，提供专业级可视化调试体验。

## 3. 技术栈
- **TUI框架**：rich（界面渲染）、click（命令行命令）
- **可视化**：langgraph-studio（工作流可视化）
- **流式处理**：asyncio（异步流式输出）
- **终端控制**：blessed（终端大小适配）

## 4. 功能性需求

### 4.1 命令行命令体系
- 基于click实现命令体系，支持以下命令：
  1. `agent run`：启动TUI交互（默认命令）
  2. `agent session list`：列出所有会话
  3. `agent session restore <session_id>`：恢复指定会话并启动TUI
  4. `agent session destroy <session_id>`：销毁指定会话
  5. `agent studio`：启动LangGraph Studio服务器
  6. `agent config check`：检查配置文件完整性
  7. `agent version`：显示框架版本

### 4.2 TUI主界面

#### 4.2.1 界面布局（使用rich Layout）
```
┌─────────────────────────────────────────┐
│ 标题栏：Modular Agent Framework v2.0    │
├───────────────┬─────────────────────────┤
│ 侧边栏（25%） │ 主内容区（75%）         │
│ - Agent信息   │ - 会话历史              │
│ - 工作流状态  │ - 流式输出              │
│ - 指标统计    │ - 工具调用结果          │
├───────────────┼─────────────────────────┤
│ LangGraph状态 │ 输入栏：用户输入        │
│ - 当前节点    │                         │
│ - 执行路径    │                         │
└─────────────────────────────────────────┘
```

#### 4.2.2 侧边栏增强
- **Agent信息**：显示当前使用的Agent名称、LLM模型、工具集
- **工作流状态**：
  - 当前节点（LangGraph节点名称）
  - 执行路径（节点执行历史）
  - 异常提示（红色显示）
- **指标统计**：
  - Token使用（`输入：1200 | 输出：800`）
  - 工具调用（`成功：3 | 失败：1`）
  - 会话时长（`00:05:30`）

#### 4.2.3 LangGraph状态面板
- **当前节点**：显示LangGraph当前执行的节点
- **执行路径**：显示节点执行历史轨迹
- **状态快照**：显示关键状态变量变化
- **Studio链接**：点击打开LangGraph Studio

#### 4.2.4 主内容区
- **会话历史**：按时间顺序显示用户输入、Agent输出、工具调用结果
- **流式输出**：实时显示LLM的流式响应
- **工具调用结果**：展开/折叠显示工具执行详情

#### 4.2.5 输入栏
- 支持多行输入（`Shift+Enter`换行）
- 输入历史：`↑`/`↓`键切换历史输入
- 命令支持：`/help`显示帮助，`/clear`清空历史，`/exit`退出TUI

### 4.3 LangGraph Studio集成

#### 4.3.1 Studio服务器管理
- 自动启动LangGraph Studio服务器（`agent studio`命令）
- 默认端口：`8079`，支持自定义端口配置
- 会话隔离：每个会话在Studio中独立显示

#### 4.3.2 可视化功能
- **实时工作流可视化**：显示当前工作流图、执行状态
- **节点调试**：点击节点查看输入输出、状态变化
- **历史回放**：回放会话执行过程
- **性能分析**：节点执行时间、资源使用统计

#### 4.3.3 TUI与Studio联动
- TUI中显示Studio访问链接
- 一键跳转到Studio进行深度调试
- Studio中修改的工作流实时同步到TUI

### 4.4 交互控制

#### 4.4.1 会话管理
- TUI启动时，提示选择Agent（列出`configs/agents/`下的配置）
- 支持会话切换（`/switch_session <session_id>`）
- 支持新建会话（`/new_session <agent_config_name>`）

#### 4.4.2 工作流控制
- 支持暂停工作流（`/pause`）、继续工作流（`/resume`）、终止工作流（`/stop`）
- 工作流执行过程中，显示LangGraph节点执行状态

#### 4.4.3 界面配置
- 支持通过配置调整TUI显示：
  ```yaml
  # global.yaml
  tui:
    show_thought: true           # 显示思考过程
    show_langgraph_panel: true   # 显示LangGraph状态面板
    studio_port: 8079           # LangGraph Studio端口
    color_scheme: "default"      # 颜色方案
  ```

### 4.5 错误与反馈
- **错误提示**：TUI中用红色显示错误信息，点击可查看详情
- **操作反馈**：成功操作用绿色显示提示
- **加载状态**：工作流执行中显示加载动画
- **Studio状态**：显示Studio服务器连接状态

## 5. 非功能性需求
- **响应性**：流式输出延迟≤100ms，无卡顿
- **适配性**：支持不同终端大小（最小宽度80字符，高度24行）
- **可视化性能**：LangGraph Studio响应流畅，支持大型工作流

## 6. 依赖接口
- `IAgentCore`（Agent核心模块）：启动Agent运行、控制工作流
- `ISessionManager`（会话管理模块）：创建/恢复/销毁会话
- `ILogger`（日志与指标模块）：显示错误信息、操作反馈
- `ILangGraphManager`（Agent核心模块）：获取工作流状态、启动Studio

## 7. 提供接口
- 无（作为用户界面层，仅调用其他模块接口，不提供对外接口）

## 8. 测试要点
- 界面布局测试：不同终端大小的适配
- 交互测试：命令、快捷键、会话切换的正确性
- LangGraph Studio集成测试：服务器启动、可视化功能
- 流式输出测试：实时显示的流畅性

## 9. 与原始设计的差异

### 新增功能
- **LangGraph状态面板**：实时显示工作流执行状态
- **Studio集成**：专业级工作流可视化调试
- **增强交互**：工作流控制与可视化联动

### 技术栈更新
- **新增**：langgraph-studio依赖
- **移除**：自定义工作流状态显示逻辑
- **简化**：利用LangGraph内置状态追踪

---
*文档版本：V2.0 - LangGraph集成版*
*更新日期：2025-10-17*