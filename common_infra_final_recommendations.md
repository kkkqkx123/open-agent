# common_infra.py æ¥å£é‡æ„ - æœ€ç»ˆå»ºè®®å’Œå®æ–½è®¡åˆ’

## ğŸ¯ æ‰§è¡Œæ‘˜è¦

åŸºäºè¯¦ç»†çš„åˆ†æï¼Œæˆ‘ä»¬å»ºè®®å¯¹ `src/interfaces/common_infra.py` è¿›è¡Œé‡æ„ï¼Œå°†æ¥å£æ‹†åˆ†åˆ°ä¸“é—¨çš„æ¨¡å—ä¸­ï¼ŒåŒæ—¶å°†å®ç°è¿ç§»åˆ°åŸºç¡€è®¾æ–½å±‚ã€‚è¿™ä¸ªæ–¹æ¡ˆæ—¢ç¬¦åˆæ¶æ„æœ€ä½³å®è·µï¼Œåˆä¿æŒäº†å‘åå…¼å®¹æ€§ã€‚

## ğŸ“Š å…³é”®å‘ç°

### 1. æ¥å£ç°çŠ¶è¯„ä¼°
- **æ‰€æœ‰æ¥å£éƒ½åº”è¯¥è¿ç§»**: 5ä¸ªæ¥å£éƒ½ç¬¦åˆåŸºç¡€è®¾æ–½å±‚ç‰¹å¾
- **ç°æœ‰ç›®å½•ç»“æ„å®Œå–„**: `storage`ã€`container`ã€`config` ç›®å½•å·²å­˜åœ¨
- **éƒ¨åˆ†æ¥å£å·²å°±ä½**: `IStorage` å’Œ `IDependencyContainer` å·²åœ¨ä¸“é—¨æ¨¡å—ä¸­

### 2. è¿ç§»å¤æ‚åº¦åˆ†æ
| æ¥å£ | è¿ç§»å¤æ‚åº¦ | é£é™©çº§åˆ« | å½±å“èŒƒå›´ |
|------|------------|----------|----------|
| ServiceLifetime | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | ä¸­ç­‰ |
| IConfigInheritanceHandler | ğŸŸ¡ ä¸­ä½ | ğŸŸ¢ ä½ | å° |
| IStorage | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ä¸­ç­‰ |
| IConfigLoader | ğŸ”´ é«˜ | ğŸ”´ é«˜ | å¤§ |
| IDependencyContainer | ğŸ”´ é«˜ | ğŸ”´ é«˜ | å¤§ |

### 3. æ¶æ„æ”¶ç›Š
- âœ… æ›´æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- âœ… ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™
- âœ… å®ç°ä¸æ¥å£æ­£ç¡®åˆ†å±‚
- âœ… æé«˜ä»£ç å¯ç»´æŠ¤æ€§

## ğŸš€ æœ€ç»ˆå»ºè®®

### å»ºè®®1: é‡‡ç”¨é‡æ„æ–¹æ¡ˆè€Œéå®Œå…¨è¿ç§»
**ç†ç”±**: 
- æ¥å£ä¿ç•™åœ¨ interfaces å±‚ç¬¦åˆåˆ†å±‚æ¶æ„åŸåˆ™
- åˆ©ç”¨ç°æœ‰ç›®å½•ç»“æ„ï¼Œå‡å°‘å˜æ›´
- ä¿æŒå‘åå…¼å®¹æ€§ï¼Œé™ä½è¿ç§»é£é™©

### å»ºè®®2: åˆ†é˜¶æ®µå®æ–½
**ç†ç”±**:
- é™ä½é£é™©ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½å¯éªŒè¯
- å…è®¸å›¢é˜Ÿé€‚åº”æ–°çš„å¯¼å…¥è·¯å¾„
- ä¾¿äºé—®é¢˜å®šä½å’Œå›æ»š

### å»ºè®®3: ä¿æŒå‘åå…¼å®¹æ€§
**ç†ç”±**:
- å¤§é‡ç°æœ‰ä»£ç ä½¿ç”¨æ—§å¯¼å…¥è·¯å¾„
- é¿å…ç ´åæ€§å˜æ›´
- æä¾›å¹³æ»‘çš„è¿‡æ¸¡æœŸ

## ğŸ“‹ è¯¦ç»†å®æ–½è®¡åˆ’

### é˜¶æ®µ1: å‡†å¤‡å’Œè§„åˆ’ (1å¤©)

#### ä»»åŠ¡æ¸…å•
- [ ] ç¡®è®¤ç°æœ‰æ¥å£ç›®å½•ç»“æ„
- [ ] å¤‡ä»½ç›¸å…³æ–‡ä»¶
- [ ] åˆ›å»ºè¿ç§»æ£€æŸ¥æ¸…å•
- [ ] å‡†å¤‡æµ‹è¯•ç¯å¢ƒ

#### äº¤ä»˜ç‰©
- è¿ç§»æ£€æŸ¥æ¸…å•
- æ–‡ä»¶å¤‡ä»½
- æµ‹è¯•ç¯å¢ƒå‡†å¤‡å°±ç»ª

### é˜¶æ®µ2: æ¥å£æ‹†åˆ† (2å¤©)

#### Day 1: ServiceLifetime å’Œé…ç½®æ¥å£
**ä»»åŠ¡æ¸…å•**:
- [ ] æ£€æŸ¥ `src/interfaces/container/core.py` ä¸­çš„ `ServiceLifetime` å®šä¹‰
- [ ] å°† `IConfigLoader` å’Œ `IConfigInheritanceHandler` æ·»åŠ åˆ° `src/interfaces/config/interfaces.py`
- [ ] æ›´æ–° `common_infra.py` çš„å¯¼å…¥è¯­å¥
- [ ] è¿è¡ŒåŸºç¡€æµ‹è¯•éªŒè¯

**éªŒæ”¶æ ‡å‡†**:
- æ‰€æœ‰æ¥å£å¯ä»¥æ­£å¸¸å¯¼å…¥
- åŸºç¡€åŠŸèƒ½æµ‹è¯•é€šè¿‡
- æ— è¯­æ³•é”™è¯¯

#### Day 2: å­˜å‚¨å’Œå®¹å™¨æ¥å£æ•´åˆ
**ä»»åŠ¡æ¸…å•**:
- [ ] éªŒè¯ `IStorage` æ¥å£å®Œæ•´æ€§
- [ ] éªŒè¯ `IDependencyContainer` æ¥å£å®Œæ•´æ€§
- [ ] æ›´æ–° `common_infra.py` çš„å¯¼å…¥è¯­å¥
- [ ] è¿è¡Œæ¥å£æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
- æ‰€æœ‰æ¥å£åŠŸèƒ½æ­£å¸¸
- æ¥å£æµ‹è¯•é€šè¿‡
- å¯¼å…¥è·¯å¾„æ­£ç¡®

### é˜¶æ®µ3: å®ç°è¿ç§» (4å¤©)

#### Day 3-4: é…ç½®å®ç°è¿ç§»
**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º `src/infrastructure/config/` ç›®å½•ç»“æ„
- [ ] è¿ç§» `ConfigLoader` å®ç°
- [ ] è¿ç§» `ConfigInheritanceHandler` å®ç°
- [ ] æ›´æ–°æ‰€æœ‰å¯¼å…¥è·¯å¾„
- [ ] æ›´æ–°æœåŠ¡ç»‘å®šé…ç½®

**å½±å“æ–‡ä»¶**:
```
src/core/config/config_loader.py â†’ src/infrastructure/config/config_loader.py
src/core/common/utils/inheritance_handler.py â†’ src/infrastructure/config/inheritance_handler.py
```

#### Day 5: å­˜å‚¨å®ç°è¿ç§»
**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º `src/infrastructure/storage/` ç›®å½•ç»“æ„
- [ ] è¿ç§» `BaseStorage` å®ç°
- [ ] æ›´æ–°æ‰€æœ‰å¯¼å…¥è·¯å¾„
- [ ] æ›´æ–°é€‚é…å™¨å®ç°

**å½±å“æ–‡ä»¶**:
```
src/core/common/storage.py â†’ src/infrastructure/storage/base_storage.py
```

#### Day 6: å®¹å™¨å®ç°è¿ç§»
**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º `src/infrastructure/container/` ç›®å½•ç»“æ„
- [ ] è¿ç§» `DependencyContainer` å®ç°
- [ ] æ›´æ–°æ‰€æœ‰å¯¼å…¥è·¯å¾„
- [ ] æ›´æ–°å…¨å±€å®¹å™¨é…ç½®

**å½±å“æ–‡ä»¶**:
```
src/services/container/core/container.py â†’ src/infrastructure/container/dependency_container.py
```

### é˜¶æ®µ4: å‘åå…¼å®¹æ€§å’Œæ¸…ç† (2å¤©)

#### Day 7: æ›´æ–° common_infra.py
**ä»»åŠ¡æ¸…å•**:
- [ ] é‡å†™ `common_infra.py` ä¸ºé‡æ–°å¯¼å‡ºæ¨¡å—
- [ ] æ·»åŠ åºŸå¼ƒè­¦å‘Š
- [ ] æ›´æ–° `__all__` åˆ—è¡¨
- [ ] æµ‹è¯•å‘åå…¼å®¹æ€§

#### Day 8: æœ€ç»ˆæ¸…ç†å’Œæµ‹è¯•
**ä»»åŠ¡æ¸…å•**:
- [ ] æ›´æ–°å„æ¨¡å—çš„ `__init__.py`
- [ ] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] æ–‡æ¡£æ›´æ–°

### é˜¶æ®µ5: éªŒè¯å’Œä¼˜åŒ– (1å¤©)

#### ä»»åŠ¡æ¸…å•
- [ ] å…¨é¢åŠŸèƒ½æµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½éªŒè¯
- [ ] ä»£ç å®¡æŸ¥

## ğŸ”§ æŠ€æœ¯å®æ–½ç»†èŠ‚

### 1. æ¥å£æ‹†åˆ†ç­–ç•¥

#### ServiceLifetime å¤„ç†
```python
# åœ¨ src/interfaces/container/core.py ä¸­ç¡®ä¿æœ‰ï¼š
class ServiceLifetime(str, Enum):
    SINGLETON = "singleton"
    TRANSIENT = "transient"
    SCOPED = "scoped"

# åœ¨ common_infra.py ä¸­é‡æ–°å¯¼å‡ºï¼š
from src.interfaces.container.core import ServiceLifetime
```

#### é…ç½®æ¥å£æ·»åŠ 
```python
# åœ¨ src/interfaces/config/interfaces.py ä¸­æ·»åŠ ï¼š
class IConfigLoader(ABC):
    # ... æ¥å£å®šä¹‰

class IConfigInheritanceHandler(ABC):
    # ... æ¥å£å®šä¹‰
```

### 2. å®ç°è¿ç§»ç­–ç•¥

#### é…ç½®åŠ è½½å™¨è¿ç§»
```python
# æ–°ä½ç½®ï¼šsrc/infrastructure/config/config_loader.py
from src.interfaces.config.interfaces import IConfigLoader

class ConfigLoader(IConfigLoader):
    # ... å®ç°ä»£ç 
```

#### å­˜å‚¨å®ç°è¿ç§»
```python
# æ–°ä½ç½®ï¼šsrc/infrastructure/storage/base_storage.py
from src.interfaces.storage.base import IStorage

class BaseStorage(IStorage):
    # ... å®ç°ä»£ç 
```

### 3. å‘åå…¼å®¹æ€§å®ç°

```python
# src/interfaces/common_infra.py çš„æ–°å†…å®¹
"""
é€šç”¨åŸºç¡€è®¾æ–½æ¥å£é‡æ–°å¯¼å‡ºæ¨¡å—

æ­¤æ¨¡å—æä¾›å‘åå…¼å®¹æ€§ï¼Œå»ºè®®ç›´æ¥ä»ä¸“é—¨çš„æ¥å£æ¨¡å—å¯¼å…¥ã€‚
å°†åœ¨ v2.0 ç‰ˆæœ¬ä¸­åºŸå¼ƒã€‚
"""

import warnings
from typing import TYPE_CHECKING

def _deprecation_warning(name: str, new_location: str):
    warnings.warn(
        f"Import '{name}' from src.interfaces.common_infra is deprecated. "
        f"Please import from '{new_location}' instead.",
        DeprecationWarning,
        stacklevel=3
    )

# é‡æ–°å¯¼å‡ºæ‰€æœ‰æ¥å£
from src.interfaces.container.core import ServiceLifetime, IDependencyContainer
from src.interfaces.storage.base import IStorage
from src.interfaces.config.interfaces import IConfigLoader, IConfigInheritanceHandler

__all__ = [
    "ServiceLifetime",
    "IDependencyContainer", 
    "IStorage",
    "IConfigLoader",
    "IConfigInheritanceHandler"
]
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
- éªŒè¯æ¯ä¸ªæ¥å£çš„åŸºæœ¬åŠŸèƒ½
- éªŒè¯å®ç°ç±»çš„æ­£ç¡®æ€§
- éªŒè¯å¯¼å…¥è·¯å¾„å˜æ›´

### 2. é›†æˆæµ‹è¯•
- éªŒè¯æœåŠ¡ç»‘å®šé…ç½®
- éªŒè¯ä¾èµ–æ³¨å…¥åŠŸèƒ½
- éªŒè¯é…ç½®åŠ è½½åŠŸèƒ½

### 3. å‘åå…¼å®¹æ€§æµ‹è¯•
- éªŒè¯æ—§å¯¼å…¥è·¯å¾„ä»ç„¶å·¥ä½œ
- éªŒè¯åºŸå¼ƒè­¦å‘Šæ­£ç¡®æ˜¾ç¤º
- éªŒè¯åŠŸèƒ½æ— å›å½’

### 4. æ€§èƒ½æµ‹è¯•
- åŸºå‡†æµ‹è¯•å¯¹æ¯”
- å†…å­˜ä½¿ç”¨æµ‹è¯•
- å¯åŠ¨æ—¶é—´æµ‹è¯•

## ğŸš¨ é£é™©ç®¡ç†

### é«˜é£é™©é¡¹ç›®
1. **å¯¼å…¥è·¯å¾„ç ´å**: å¤§é‡ç°æœ‰ä»£ç ä½¿ç”¨æ—§è·¯å¾„
2. **å¾ªç¯ä¾èµ–**: æ–°çš„å¯¼å…¥ç»“æ„å¯èƒ½å¼•å…¥å¾ªç¯ä¾èµ–
3. **æœåŠ¡ç»‘å®šå¤±æ•ˆ**: å®ç°è¿ç§»å¯èƒ½å½±å“æœåŠ¡ç»‘å®š

### ç¼“è§£æªæ–½
1. **åˆ†é˜¶æ®µå®æ–½**: æ¯ä¸ªé˜¶æ®µéƒ½è¿›è¡Œå……åˆ†æµ‹è¯•
2. **å‘åå…¼å®¹æ€§**: ä¿æŒé‡æ–°å¯¼å‡ºæ¨¡å—
3. **å…¨é¢æµ‹è¯•**: æ¯ä¸ªå˜æ›´éƒ½è¿›è¡Œæµ‹è¯•éªŒè¯
4. **å›æ»šè®¡åˆ’**: å‡†å¤‡å¿«é€Ÿå›æ»šæ–¹æ¡ˆ

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ç‡ â‰¥ 99%
- [ ] æ€§èƒ½å›å½’ < 5%
- [ ] é›¶å¾ªç¯ä¾èµ–
- [ ] å‘åå…¼å®¹æ€§ 100%

### æ¶æ„æŒ‡æ ‡
- [ ] æ¥å£èŒè´£æ¸…æ™°åˆ†ç¦»
- [ ] å®ç°æ­£ç¡®åˆ†å±‚
- [ ] ä»£ç å¤æ‚åº¦é™ä½
- [ ] å¯ç»´æŠ¤æ€§æå‡

## ğŸ“… æ—¶é—´è¡¨å’Œé‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å®Œæˆæ—¥æœŸ | å…³é”®äº¤ä»˜ç‰© |
|--------|----------|------------|
| M1: æ¥å£æ‹†åˆ†å®Œæˆ | Week 1 Day 2 | æ‰€æœ‰æ¥å£æ­£ç¡®æ‹†åˆ† |
| M2: å®ç°è¿ç§»å®Œæˆ | Week 2 Day 2 | æ‰€æœ‰å®ç°è¿ç§»åˆ°åŸºç¡€è®¾æ–½å±‚ |
| M3: å‘åå…¼å®¹æ€§å®Œæˆ | Week 2 Day 4 | é‡æ–°å¯¼å‡ºæ¨¡å—å°±ä½ |
| M4: æµ‹è¯•éªŒè¯å®Œæˆ | Week 2 Day 5 | æ‰€æœ‰æµ‹è¯•é€šè¿‡ |

## ğŸ¯ é•¿æœŸè§„åˆ’

### åºŸå¼ƒæ—¶é—´è¡¨
- **v1.8**: å‘å¸ƒé‡æ–°å¯¼å‡ºæ¨¡å—ï¼Œå¼€å§‹åºŸå¼ƒè­¦å‘Š
- **v1.9**: åŠ å¼ºåºŸå¼ƒè­¦å‘Šï¼Œæä¾›è¿ç§»æŒ‡å—
- **v2.0**: ç§»é™¤ `common_infra.py` é‡æ–°å¯¼å‡ºæ¨¡å—

### åç»­ä¼˜åŒ–
1. **æ¥å£è¿›ä¸€æ­¥ç»†åŒ–**: æ ¹æ®ä½¿ç”¨æƒ…å†µè¿›ä¸€æ­¥ç»†åŒ–æ¥å£
2. **å®ç°ä¼˜åŒ–**: åŸºäºåŸºç¡€è®¾æ–½å±‚çš„ç‰¹æ€§ä¼˜åŒ–å®ç°
3. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°æ‰€æœ‰ç›¸å…³æ–‡æ¡£å’Œç¤ºä¾‹

## ğŸ“ ç»“è®º

è¿™ä¸ªé‡æ„æ–¹æ¡ˆå¹³è¡¡äº†æ¶æ„ä¼˜åŒ–å’Œå®æ–½é£é™©ï¼Œé€šè¿‡åˆ†é˜¶æ®µå®æ–½å’Œå‘åå…¼å®¹æ€§ä¿è¯ï¼Œç¡®ä¿äº†è¿ç§»çš„å¹³ç¨³è¿›è¡Œã€‚é‡æ„å®Œæˆåï¼Œç³»ç»Ÿå°†æ‹¥æœ‰æ›´æ¸…æ™°çš„æ¶æ„åˆ†å±‚ï¼Œæ›´å¥½çš„å¯ç»´æŠ¤æ€§ï¼Œä¸ºæœªæ¥çš„å‘å±•å¥ å®šäº†åšå®åŸºç¡€ã€‚

**å…³é”®æˆåŠŸå› ç´ **:
1. ä¸¥æ ¼æŒ‰ç…§åˆ†é˜¶æ®µè®¡åˆ’æ‰§è¡Œ
2. ä¿æŒå……åˆ†çš„æµ‹è¯•è¦†ç›–
3. åŠæ—¶æ²Ÿé€šå’Œæ–‡æ¡£æ›´æ–°
4. ç›‘æ§æ€§èƒ½å’Œç¨³å®šæ€§æŒ‡æ ‡

é€šè¿‡è¿™ä¸ªæ–¹æ¡ˆï¼Œæˆ‘ä»¬æ—¢å®ç°äº†æ¶æ„ä¼˜åŒ–ç›®æ ‡ï¼Œåˆæœ€å°åŒ–äº†è¿ç§»é£é™©ï¼Œæ˜¯ä¸€ä¸ªå¹³è¡¡ä¸”å¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚